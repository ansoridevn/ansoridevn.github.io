<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ansori POS | Pro Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0F172A">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2434/2434440.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ansori POS">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2434/2434440.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-base:#F8FAFC; --bg-surface:#FFFFFF; --accent:#D97706; --accent-soft:#FEF3C7;    
            --text-main:#0F172A; --text-muted:#64748B; --border:#E2E8F0;
            --success:#059669; --success-soft:#D1FAE5; --danger:#DC2626; --danger-soft:#FEE2E2;
            --info:#0284C7; --warning:#F59E0B; --shadow-sm:0 1px 3px rgba(0,0,0,0.05); --shadow-md:0 4px 15px rgba(0,0,0,0.05); --radius:16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans', sans-serif; }
        body { background:var(--bg-base); color:var(--text-main); height:100dvh; display:flex; overflow:hidden; }

        .btn { background:var(--text-main); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer; transition:0.2s; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
        .btn:active { transform:scale(0.96); }
        .btn-success { background:var(--success); } .btn-danger { background:var(--danger); }
        .btn-warning { background:var(--warning); color:white; } .btn-info { background:var(--info); color:white; }
        .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-main); }
        .btn-sm { padding:6px 12px; font-size:0.8rem; }
        
        .input-group { margin-bottom:15px; } .input-label { display:block; font-size:0.8rem; font-weight:600; color:var(--text-muted); margin-bottom:5px; }
        .input-field { width:100%; padding:12px; background:var(--bg-base); border:1px solid var(--border); border-radius:8px; outline:none; transition:0.2s; }
        .input-field:focus { border-color:var(--accent); background:white; box-shadow:0 0 0 3px var(--accent-soft); }
        select.input-field { appearance:none; cursor:pointer; }
        .badge { padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700; display:inline-block; }
        .badge-success { background:var(--success-soft); color:var(--success); } .badge-danger { background:var(--danger-soft); color:var(--danger); }
        .badge-warning { background:#FEF3C7; color:var(--warning); } .badge-info { background:#E0F2FE; color:var(--info); }

        #setup-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-base); z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px; }
        .setup-card { background:white; padding:40px; border-radius:var(--radius); box-shadow:var(--shadow-md); width:100%; max-width:500px; max-height:90vh; overflow-y:auto;}
        .mode-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:20px; }
        .mode-card { border:2px solid var(--border); padding:15px; text-align:center; border-radius:12px; cursor:pointer; transition:0.2s; }
        .mode-card.active { border-color:var(--accent); background:var(--accent-soft); }

        #app-shell { display:none; width:100%; height:100%; }
        nav { width:85px; background:var(--bg-surface); border-right:1px solid var(--border); display:flex; flex-direction:column; align-items:center; padding:20px 0; z-index:20; flex-shrink:0; }
        .nav-logo { font-weight:800; font-size:1.5rem; margin-bottom:30px; color:var(--accent); }
        .nav-item { width:65px; height:65px; border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); cursor:pointer; margin-bottom:5px; transition:0.2s; position:relative;}
        .nav-item i { font-size:1.3rem; } .nav-item span { font-size:0.6rem; margin-top:6px; font-weight:700; text-transform:uppercase; }
        .nav-item:hover, .nav-item.active { background:var(--accent-soft); color:var(--accent); }
        .mode-specific { display:none; }

        main { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
        header { padding:10px 25px; background:white; border-bottom:1px solid var(--border); z-index:10; flex-shrink:0;}
        .dynamic-island-wrapper { position:relative; display:flex; justify-content:center; top:-1px; z-index:9;}
        .dynamic-island { background:#0F172A; color:white; padding:6px 20px; border-radius:0 0 16px 16px; font-size:0.75rem; font-weight:500; display:inline-flex; align-items:center; gap:6px; box-shadow:var(--shadow-sm); border:1px solid #334155; border-top:none;}
        .dynamic-island a { color:#38BDF8; text-decoration:none; font-weight:700; }
        .beat-icon { color:#EF4444; animation:beat 1s infinite; }
        @keyframes beat { 0%, 100% { transform:scale(1); } 50% { transform:scale(1.3); } }

        .view-section { display:none; height:100%; width:100%; overflow-y:auto; padding-bottom:20px;} .view-section.active { display:block; }
        .tab-header { display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px; overflow-x:auto; white-space:nowrap;}
        .tab-btn { background:none; border:none; font-size:1rem; font-weight:600; color:var(--text-muted); cursor:pointer; padding:5px 10px; transition:0.2s;}
        .tab-btn.active { color:var(--accent); border-bottom:3px solid var(--accent); }
        .tab-content { display:none; } .tab-content.active { display:block; }

        #view-kasir { display:none; } #view-kasir.active { display:flex; } 
        .pos-products { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; }
        .search-bar { display:flex; gap:10px; margin-bottom:20px; flex-shrink:0; }
        .product-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:15px; align-content:start;}
        .product-card { background:white; border:1px solid var(--border); border-radius:12px; padding:15px; cursor:pointer; transition:0.2s; box-shadow:var(--shadow-sm); display:flex; flex-direction:column; justify-content:space-between; min-height:120px; position:relative; }
        .product-card:active { transform:scale(0.96); border-color:var(--accent); }
        .best-badge { position:absolute; top:-8px; right:-8px; background:var(--danger); color:white; font-size:0.65rem; padding:4px 8px; border-radius:12px; font-weight:bold; box-shadow:var(--shadow-sm); z-index:2; border:2px solid white; }
        
        .pos-cart { width:380px; background:white; border-left:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; z-index:105;}
        .cart-header { padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:700; flex-shrink:0;}
        .cart-items { flex:1; overflow-y:auto; padding:15px; }
        .cart-item { display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed var(--border); }
        .qty-control { display:flex; align-items:center; background:var(--bg-base); border-radius:6px; padding:2px; }
        .qty-btn { background:none; border:none; width:24px; height:24px; cursor:pointer; font-weight:bold; color:var(--text-main); }
        .cart-summary { padding:20px; background:var(--bg-base); border-top:1px solid var(--border); flex-shrink:0;}
        .sum-row { display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem; color:var(--text-muted); }
        .sum-total { display:flex; justify-content:space-between; font-size:1.3rem; font-weight:800; margin:15px 0; color:var(--success); }
        
        #mobile-cart-toggle, .close-cart-btn { display:none; }

        .data-container { padding:30px; width:100%; overflow-y:auto; }
        .data-card { background:white; border:1px solid var(--border); border-radius:12px; padding:20px; box-shadow:var(--shadow-sm); margin-bottom:20px; }
        
        .table-responsive { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
        table { width:100%; border-collapse:collapse; } 
        th, td { padding:12px 15px; text-align:left; border-bottom:1px solid var(--border); font-size:0.9rem;}
        th { font-size:0.8rem; text-transform:uppercase; color:var(--text-muted); background:var(--bg-base); white-space:nowrap; } 
        tr:hover { background:var(--bg-base); }

        .kds-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:20px; }
        .kds-ticket { background:white; border:1px solid var(--border); border-radius:12px; padding:15px; box-shadow:var(--shadow-sm); border-top:4px solid var(--warning); display:flex; flex-direction:column; justify-content:space-between;}
        .kds-ticket.done { border-top-color:var(--success); opacity:0.6; }

        .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:20px; margin-bottom:20px; }
        .metric-card { background:white; padding:15px; border-radius:12px; border:1px solid var(--border); text-align:center; box-shadow:var(--shadow-sm);}
        .metric-value { font-size:1.8rem; font-weight:800; color:var(--text-main); margin-top:5px;}

        /* MODALS */
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; display:none; align-items:center; justify-content:center; backdrop-filter:blur(2px); }
        .modal-content { background:white; border-radius:var(--radius); width:100%; max-width:450px; padding:30px; box-shadow:var(--shadow-md); position:relative; max-height:90vh; overflow-y:auto; }
        .modal-close { position:absolute; top:20px; right:20px; cursor:pointer; font-size:1.5rem; color:var(--text-muted); z-index:10; }

        .pay-amount-display { font-size:2.5rem; font-weight:800; text-align:center; color:var(--success); margin-bottom:20px; }
        .quick-cash-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; }
        .quick-cash-btn { padding:10px; background:var(--bg-base); border:1px solid var(--border); border-radius:8px; text-align:center; cursor:pointer; font-weight:600; }

        #qr-container, #reader-container { display:flex; justify-content:center; margin:20px 0; padding:20px; background:var(--bg-base); border-radius:12px; border:1px solid var(--border); overflow:hidden; }
        #qr-container img { max-width:100%; height:auto; } #reader { width:100%; border:none !important; }

        #receipt-print-area { width:300px; margin:0 auto; background:white; padding:20px; font-family:monospace; color:black; border:1px solid #ccc; }
        .rcpt-center { text-align:center; } .rcpt-line { border-top:1px dashed black; margin:10px 0; } .rcpt-flex { display:flex; justify-content:space-between; margin-bottom:4px; }

        /* PRINT STYLES - DUAL MODE (RECEIPT vs REPORT) */
        @media print {
            body { background:white; overflow:visible; height:auto; }
            #setup-screen, #app-shell, .modal-overlay, .no-print { display:none !important; }
            body.print-receipt #receipt-modal { display:block !important; position:static; background:white; padding:0; }
            body.print-receipt .modal-content { box-shadow:none; width:100%; max-width:none; padding:0; margin:0; border-radius:0; }
            body.print-receipt #receipt-print-area { width:58mm; margin:0; padding:0; border:none; font-size:12px; color:black; }
            body.print-report #app-shell { display:flex !important; }
            body.print-report nav, body.print-report header, body.print-report .tab-header, body.print-report .dynamic-island-wrapper { display:none !important; }
            body.print-report main { overflow:visible; height:auto; display:block; }
            body.print-report #view-laporan { display:block !important; overflow:visible; height:auto; padding:0; }
            body.print-report .data-container { padding:0; }
            body.print-report .data-card { box-shadow:none; border:1px solid #ccc; break-inside:avoid; }
            body.print-report table { border:1px solid #ccc; }
        }

        /* NAVIGATION LOGIC (DESKTOP) */
        #nav-laporan { display:flex; }
        .hide-desktop-only { display:none !important; }

        /* NAVIGATION LOGIC (MOBILE) */
        @media (max-width:768px) {
            #app-shell { flex-direction:column; }
            nav { width:100%; height:auto; min-height:70px; flex-direction:row; justify-content:space-around; order:3; border-right:none; border-top:1px solid var(--border); padding:0; padding-bottom:env(safe-area-inset-bottom); z-index:50; }
            .nav-logo { display:none; } .nav-item { flex:1; height:70px; margin:0; border-radius:0; } .nav-item i { font-size:1.2rem; }
            #nav-kasir { position:relative; top:-15px; background:var(--accent); color:white; border-radius:50%; height:70px; width:70px; max-width:70px; box-shadow:0 4px 15px rgba(217,119,6,0.4); border:4px solid var(--bg-surface); }
            #nav-kasir span { color:white; margin-top:2px;} #nav-kasir.active { background:var(--accent); color:white; transform:scale(1.05);}
            main { flex:1; width:100%; height:auto; } header { padding:calc(10px + env(safe-area-inset-top)) 15px 10px 15px; }
            .view-section { display:none; height:100%; padding-bottom:20px; overflow-y:auto; } .view-section.active { display:block; }
            body.mode-dapur-active #view-kasir { display:block !important; height:55%; border-bottom:3px solid var(--border); } body.mode-dapur-active #view-dapur { display:block !important; height:45%; padding-bottom:0; }
            #view-kasir { position:relative; } #view-kasir.active { display:block; }
            .pos-products { height:100%; padding:15px; padding-bottom:80px; }
            .pos-cart { position:fixed; top:0; right:-100%; height:calc(100dvh - 70px - env(safe-area-inset-bottom)); width:100%; transition:0.3s cubic-bezier(0.4,0,0.2,1); box-shadow:-5px 0 15px rgba(0,0,0,0.1); }
            .pos-cart.open { right:0; }
            #mobile-cart-toggle { display:flex; position:absolute; bottom:20px; left:50%; transform:translateX(-50%); background:var(--text-main); color:white; border-radius:30px; padding:10px 25px; box-shadow:var(--shadow-md); z-index:90; font-weight:700; border:none; align-items:center; gap:12px; width:max-content; max-width:90%; text-align:left; }
            .close-cart-btn { display:block; background:none; border:none; font-size:1.5rem; color:var(--text-muted); cursor:pointer;}
            .product-grid { grid-template-columns:repeat(auto-fill, minmax(110px, 1fr)); }
            .data-container { padding:15px; } .data-card { padding:15px; } 
            table { min-width: 600px; } th, td { padding: 8px 10px; font-size: 0.8rem; }
            .metrics-grid { grid-template-columns:1fr 1fr; } 
            
            /* Logic View Mode Navigasi Bawah & Setting Laporan */
            .hide-mobile { display:none !important; }
            body:not(.mode-retail) #nav-laporan { display:none !important; } 
            body.mode-retail #nav-laporan { display:flex !important; } 
            body.mode-retail #mobile-setting-laporan { display:none !important; } 
            body:not(.mode-retail) #mobile-setting-laporan { display:block !important; } 
        }
    </style>
</head>
<body class="mode-fnb"> 

    <div id="setup-screen">
        <div class="setup-card">
            <h1 style="text-align:center; margin-bottom:5px;">Ansori POS</h1>
            <p style="text-align:center; color:var(--text-muted); margin-bottom:30px;">Sistem Kasir Offline UMKM</p>
            
            <div class="input-group"><label class="input-label">Nama Bisnis / Toko</label><input type="text" id="setup-name" class="input-field" placeholder="Cth: Kedai Ansori" value="Toko Ansori"></div>

            <div class="input-group">
                <label class="input-label">Pilih Mode Sistem</label>
                <div class="mode-grid">
                    <div class="mode-card active" onclick="selectMode('fnb', this)"><i class="fas fa-utensils" style="font-size:1.5rem; margin-bottom:5px; color:var(--accent);"></i><br>F&B</div>
                    <div class="mode-card" onclick="selectMode('retail', this)"><i class="fas fa-barcode" style="font-size:1.5rem; margin-bottom:5px; color:var(--info);"></i><br>Retail</div>
                    <div class="mode-card" onclick="selectMode('jasa', this)"><i class="fas fa-concierge-bell" style="font-size:1.5rem; margin-bottom:5px; color:var(--success);"></i><br>Jasa</div>
                </div>
            </div>

            <button class="btn" style="width:100%; padding:15px; font-size:1.1rem; margin-bottom:15px;" onclick="saveSetup()">Buka Toko Sekarang</button>
            <div style="text-align:center; font-size:0.9rem; color:var(--text-muted);">
                Sudah punya backup XML? <a href="#" onclick="document.getElementById('modal-setup-import').style.display='flex'" style="color:var(--info); font-weight:bold;">Import di sini</a>
            </div>
        </div>
    </div>

    <div id="app-shell">
        <nav>
            <div class="nav-logo">A.</div>
            <div class="nav-item" id="nav-produk" onclick="switchView('produk', this)" title="Produk"><i class="fas fa-box"></i><span>Produk</span></div>
            <div class="nav-item" id="nav-stok" onclick="switchView('stok', this)" title="Inventori"><i class="fas fa-boxes"></i><span>Stok</span></div>
            <div class="nav-item active" id="nav-kasir" onclick="switchView('kasir', this)" title="Kasir"><i class="fas fa-cash-register"></i><span>Kasir</span></div>
            
            <div class="nav-item mode-specific mode-fnb" id="nav-dapur" onclick="switchView('dapur', this)" title="Kitchen Display"><i class="fas fa-fire-burner"></i><span>Dapur</span></div>
            <div class="nav-item mode-specific mode-jasa" id="nav-booking" onclick="switchView('booking', this)" title="Booking Jadwal"><i class="fas fa-calendar-check"></i><span>Booking</span></div>
            
            <div style="flex:1;" class="hide-mobile"></div>
            <div class="nav-item" id="nav-laporan" onclick="switchView('laporan', this)" title="Laporan"><i class="fas fa-chart-bar"></i><span>Laporan</span></div>
            <div class="nav-item" id="nav-pengaturan" onclick="checkPinAndEnterSettings(this)" title="Pengaturan"><i class="fas fa-cog"></i><span>Setting</span></div>
        </nav>

        <main>
            <header>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div><h2 id="store-title" style="margin:0;">Loading...</h2><span id="store-mode" class="badge" style="background:var(--bg-base); color:var(--text-muted); border:1px solid var(--border);">MODE</span></div>
                    <div style="font-weight:600; color:var(--text-muted);"><i class="far fa-clock"></i> <span id="clock">--:--</span></div>
                </div>
            </header>
            
            <div class="dynamic-island-wrapper no-print"><div class="dynamic-island">Build with <i class="fas fa-heart beat-icon"></i> by <a href="https://ahmadansori.com" target="_blank">Ahmad Ansori</a></div></div>

            <div id="view-kasir" class="view-section active">
                <div class="pos-products">
                    <div class="search-bar">
                        <button class="btn btn-info" style="padding:0 15px;" onclick="openCameraScanner()"><i class="fas fa-camera"></i></button>
                        <input type="text" id="pos-search" class="input-field" placeholder="Cari / Scan (F2)..." style="margin:0;" autofocus autocomplete="off">
                        <button class="btn btn-outline" style="white-space:nowrap; padding:0 15px;" onclick="showQRMenu()"><i class="fas fa-qrcode"></i> <span class="hide-mobile" style="margin-left:5px;">QR Menu</span></button>
                    </div>
                    <div class="product-grid" id="pos-product-grid"></div>
                </div>
                
                <button id="mobile-cart-toggle" onclick="toggleMobileCart()"><i class="fas fa-shopping-basket" style="font-size:1.5rem; color:var(--accent);"></i><span id="mobile-cart-badge">0 Item | Rp 0</span></button>

                <div class="pos-cart" id="pos-cart-panel">
                    <div class="cart-header">
                        <span style="color:var(--danger); cursor:pointer; font-size:0.9rem; padding:5px;" onclick="requestConfirm('Void pesanan ini?', clearCart)"><i class="fas fa-trash"></i> Void</span>
                        <span style="font-weight:800;"><i class="fas fa-shopping-cart"></i> Pesanan</span>
                        <button class="close-cart-btn" onclick="toggleMobileCart()"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="cart-items" id="cart-list"></div>
                    <div class="cart-summary">
                        <div class="sum-row"><span>Subtotal</span><span id="cart-subtotal">Rp 0</span></div>
                        <div class="sum-row"><span>Diskon <span style="font-size:0.7rem; cursor:pointer; color:var(--info);" onclick="openDiscountPrompt()">[Edit]</span></span><span id="cart-discount" style="color:var(--danger);">-Rp 0</span></div>
                        <div class="sum-row" id="row-tax"><span>Pajak (<span id="tax-rate-display">0</span>%)</span><span id="cart-tax">Rp 0</span></div>
                        <div class="sum-total"><span>Total</span><span id="cart-total">Rp 0</span></div>
                        <button class="btn btn-success" style="width:100%; font-size:1.1rem; padding:15px;" onclick="openPaymentModal()"><i class="fas fa-wallet"></i> Bayar (F9)</button>
                    </div>
                </div>
            </div>

            <div id="view-produk" class="view-section">
                <div class="data-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                        <h2 style="font-size:1.3rem;">Manajemen Produk & Jasa</h2>
                        <button class="btn" onclick="openProductModal()"><i class="fas fa-plus"></i> <span class="hide-mobile">Tambah</span></button>
                    </div>
                    
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="switchTab('view-produk', 'tab-prod-list', this)">Daftar Produk</button>
                        <button class="tab-btn" onclick="switchTab('view-produk', 'tab-prod-opname', this)">Opname & Review</button>
                    </div>

                    <div id="tab-prod-list" class="tab-content active data-card">
                        <input type="text" id="search-prod" class="input-field" placeholder="Cari Nama / SKU / Kategori..." onkeyup="renderAdminProducts()" style="margin-bottom: 15px;">
                        <div class="table-responsive">
                            <table id="product-table">
                                <thead><tr><th>SKU/Barcode</th><th>Nama</th><th>Kategori</th><th>Modal</th><th>Jual</th><th>Stok</th><th>Aksi</th></tr></thead>
                                <tbody id="product-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-prod-opname" class="tab-content">
                        <div class="metrics-grid">
                            <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Total Varian Item</div><div class="metric-value" id="opn-total-item">0</div></div>
                            <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Total Modal Tersimpan</div><div class="metric-value" style="color:var(--danger);" id="opn-total-cost">Rp 0</div></div>
                            <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Potensi Nilai Jual</div><div class="metric-value" style="color:var(--success);" id="opn-total-value">Rp 0</div></div>
                        </div>
                        <div class="data-card">
                            <h3 style="margin-bottom:15px;">Daftar Aset Fisik</h3>
                            <div class="table-responsive">
                                <table><thead><tr><th>Nama Item</th><th>Stok</th><th>Total Modal</th><th>Potensi Jual</th></tr></thead><tbody id="opn-asset-body"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-stok" class="view-section">
                <div class="data-container">
                    <h2 style="font-size:1.3rem; margin-bottom:10px;">Inventori & Stok Opname</h2>
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="switchTab('view-stok', 'tab-stok-mutasi', this)">Mutasi & Info Stok</button>
                        <button class="tab-btn" onclick="switchTab('view-stok', 'tab-stok-sync', this)">Sync / Opname Fisik</button>
                    </div>

                    <div id="tab-stok-mutasi" class="tab-content active">
                        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <label style="font-size:0.9rem; font-weight:600;">Periode Terjual:</label>
                            <select id="filter-stok" class="input-field" style="width:auto; padding:8px; margin:0;" onchange="toggleCustomDate('stok')">
                                <option value="daily">Hari Ini</option><option value="weekly">7 Hari Terakhir</option><option value="monthly">Bulan Ini</option><option value="custom">Pilih Tanggal...</option>
                            </select>
                            <div id="custom-date-stok" style="display:none; gap:5px; flex-wrap:wrap;">
                                <input type="date" id="start-stok" class="input-field" style="padding:8px; margin:0; width:auto;" onchange="renderStockTable()">
                                <input type="date" id="end-stok" class="input-field" style="padding:8px; margin:0; width:auto;" onchange="renderStockTable()">
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="table-responsive">
                                <table><thead><tr><th>Produk</th><th>Stok Saat Ini</th><th>Terjual (Periode)</th><th>Kontrol Stok</th></tr></thead><tbody id="stock-table-body"></tbody></table>
                            </div>
                        </div>
                    </div>

                    <div id="tab-stok-sync" class="tab-content data-card">
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">Masukkan jumlah stok fisik sebenarnya, sistem otomatis menyesuaikan perbedaannya.</p>
                        <div class="table-responsive">
                            <table><thead><tr><th>Produk</th><th>Stok Sistem</th><th>Stok Fisik Aktual</th><th>Aksi</th></tr></thead><tbody id="stok-sync-body"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-laporan" class="view-section">
                <div class="data-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center; flex-wrap:wrap; gap:10px;">
                        <h2 style="font-size:1.3rem;">Laporan Penjualan</h2>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <select id="filter-laporan" class="input-field no-print" style="width:auto; padding:8px; margin:0;" onchange="toggleCustomDate('laporan')">
                                <option value="daily">Hari Ini</option><option value="weekly">7 Hari Terakhir</option><option value="monthly">Bulan Ini</option><option value="custom">Pilih Tanggal...</option>
                            </select>
                            <div id="custom-date-laporan" style="display:none; gap:5px; flex-wrap:wrap;" class="no-print">
                                <input type="date" id="start-laporan" class="input-field" style="padding:8px; margin:0; width:auto;" onchange="renderReports()">
                                <input type="date" id="end-laporan" class="input-field" style="padding:8px; margin:0; width:auto;" onchange="renderReports()">
                            </div>
                            <button class="btn btn-outline no-print" onclick="printReportPDF()"><i class="fas fa-file-pdf"></i> <span class="hide-mobile">Cetak PDF</span></button>
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Omzet Terpilih</div><div class="metric-value" style="color:var(--success);" id="report-omzet">Rp 0</div></div>
                        <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Total Transaksi</div><div class="metric-value" id="report-tx-count">0</div></div>
                        <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Est. Laba Kotor</div><div class="metric-value" style="color:var(--info);" id="report-laba">Rp 0</div></div>
                    </div>
                    
                    <div class="data-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                            <h3 style="margin:0;">Riwayat Transaksi</h3>
                            <input type="text" id="search-tx" class="input-field no-print" placeholder="Cari ID / Metode Bayar..." onkeyup="renderReports()" style="width:250px; margin:0;">
                        </div>
                        <div class="table-responsive">
                            <table><thead><tr><th>ID</th><th>Waktu</th><th>Item</th><th>Metode</th><th>Total</th><th class="no-print">Aksi</th></tr></thead><tbody id="tx-history-body"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-dapur" class="view-section">
                <div class="data-container">
                    <h2 style="font-size:1.3rem; margin-bottom:10px;">Kitchen Display System (KDS)</h2>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;"><i class="fas fa-sync fa-spin"></i> Layar otomatis sinkronisasi antar perangkat.</p>
                    
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="switchTab('view-dapur', 'tab-kds-antrian', this)">Antrian Berjalan</button>
                        <button class="tab-btn" onclick="switchTab('view-dapur', 'tab-kds-kinerja', this)">Kinerja & Opname Dapur</button>
                    </div>

                    <div id="tab-kds-antrian" class="tab-content active"><div class="kds-grid" id="kds-container"></div></div>
                    <div id="tab-kds-kinerja" class="tab-content">
                        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <label style="font-size:0.9rem; font-weight:600;">Periode Laporan:</label>
                            <select id="filter-kds" class="input-field" style="width:auto; padding:8px; margin:0;" onchange="toggleCustomDate('kds')">
                                <option value="daily">Hari Ini</option><option value="weekly">7 Hari Terakhir</option><option value="monthly">Bulan Ini</option><option value="custom">Pilih Tanggal...</option>
                            </select>
                            <div id="custom-date-kds" style="display:none; gap:5px; flex-wrap:wrap;">
                                <input type="date" id="start-kds" class="input-field" style="padding:8px; margin:0; width:auto;" onchange="renderKDSMetrics()">
                                <input type="date" id="end-kds" class="input-field" style="padding:8px; margin:0; width:auto;" onchange="renderKDSMetrics()">
                            </div>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Diselesaikan</div><div class="metric-value" id="kds-done-count">0</div></div>
                            <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Rata-rata Masak</div><div class="metric-value" style="color:var(--info);" id="kds-avg-time">0m</div></div>
                        </div>
                        <div class="data-card">
                            <h3 style="margin-bottom:15px;">Opname Menu Dimasak</h3>
                            <div class="table-responsive">
                                <table><thead><tr><th>Nama Menu</th><th>Kategori</th><th>Porsi</th></tr></thead><tbody id="kds-opname-body"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-booking" class="view-section">
                <div class="data-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                        <h2 style="font-size:1.3rem;">Manajemen Reservasi</h2>
                        <button class="btn" onclick="document.getElementById('modal-add-booking').style.display='flex'"><i class="fas fa-plus"></i> Buat</button>
                    </div>
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="switchTab('view-booking', 'tab-book-list', this)">Daftar Jadwal</button>
                        <button class="tab-btn" onclick="switchTab('view-booking', 'tab-book-kinerja', this)">Overview Kinerja</button>
                    </div>
                    <div id="tab-book-list" class="tab-content active data-card">
                        <div class="table-responsive">
                            <table><thead><tr><th>Tgl & Jadwal</th><th>Nama & Layanan</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="booking-table-body"></tbody></table>
                        </div>
                    </div>
                    <div id="tab-book-kinerja" class="tab-content"><div class="metrics-grid">
                        <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Total Reservasi</div><div class="metric-value" id="book-total">0</div></div>
                        <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Tepat Waktu</div><div class="metric-value" style="color:var(--success);" id="book-ontime">0</div></div>
                        <div class="metric-card"><div style="font-size:0.85rem; color:var(--text-muted);">Terlambat</div><div class="metric-value" style="color:var(--danger);" id="book-late">0</div></div>
                    </div></div>
                </div>
            </div>

            <div id="view-pengaturan" class="view-section">
                <div class="data-container">
                    <h2 style="font-size:1.3rem; margin-bottom:15px;">Pengaturan Sistem</h2>
                    
                    <div id="pwa-install-container" style="display:none; background:var(--success-soft); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--success);">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div><h3 style="color:var(--success); margin-bottom:5px; font-size:1.1rem;"><i class="fas fa-mobile-alt"></i> Install Aplikasi (PWA)</h3><p style="font-size:0.85rem; color:var(--success);">Install POS ini ke Home Screen.</p></div>
                            <button class="btn btn-success" id="btn-install-pwa" onclick="installPWA()">Install</button>
                        </div>
                    </div>

                    <div class="data-card hide-desktop-only" id="mobile-setting-laporan" style="margin-bottom:20px; border-left:4px solid var(--info);">
                        <h3><i class="fas fa-chart-bar" style="color:var(--info)"></i> Laporan Bisnis</h3>
                        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">Lihat rekapitulasi penjualan, omzet, dan performa toko.</p>
                        <button class="btn btn-info" style="width:100%;" onclick="switchView('laporan')">Buka Laporan</button>
                    </div>

                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
                        <div class="data-card">
                            <h3><i class="fas fa-store"></i> Profil Toko & PIN</h3>
                            <div class="input-group" style="margin-top:15px;"><label class="input-label">Pajak / PPN (%)</label><input type="number" id="setting-tax" class="input-field" value="0"></div>
                            <div class="input-group"><label class="input-label">Ubah PIN Admin Baru</label><input type="password" id="setting-pin" class="input-field" placeholder="Masukkan PIN baru" maxlength="6"></div>
                            <button class="btn" style="width:100%;" onclick="saveSettings()">Simpan Pengaturan</button>
                        </div>
                        <div class="data-card">
                            <h3><i class="fas fa-database"></i> Backup & Restore</h3>
                            <button class="btn btn-outline" style="width:100%; margin-bottom:10px; margin-top:15px;" onclick="exportXML()"><i class="fas fa-download"></i> Ekspor Data XML</button>
                            <input type="file" id="xml-upload" accept=".xml" style="margin-bottom:5px; display:block; width:100%;">
                            <div style="display:flex; gap:10px; margin-bottom:20px;">
                                <button class="btn btn-outline" style="flex:1; padding:10px 5px;" onclick="requireAdmin(()=>importXML('replace', 'xml-upload'))"><i class="fas fa-upload"></i> Restore</button>
                                <button class="btn" style="flex:1; padding:10px 5px;" onclick="requireAdmin(()=>importXML('merge', 'xml-upload'))"><i class="fas fa-object-group"></i> Gabung</button>
                            </div>
                            <hr style="border-top:1px solid var(--border); border-bottom:none;">
                            <button class="btn btn-danger" style="width:100%; margin-top:15px;" onclick="requireAdmin(()=>requestConfirm('Yakin reset pabrik? Semua terhapus!', resetApp))"><i class="fas fa-trash"></i> Reset Pabrik</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modal-pin">
        <div class="modal-content" style="max-width:300px; text-align:center;">
            <i class="fas fa-times modal-close" onclick="closeModal('modal-pin')"></i>
            <div style="font-size:3rem; margin-bottom:15px; color:var(--danger);"><i class="fas fa-lock"></i></div>
            <h3 style="margin-bottom:10px;">Otorisasi Kasir</h3>
            <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.85rem;">Masukkan PIN Admin Anda.</p>
            <input type="password" id="pin-input" class="input-field" style="text-align:center; font-size:1.5rem; letter-spacing:5px; margin-bottom:15px;" maxlength="6">
            <button class="btn btn-danger" style="width:100%;" onclick="verifyPin()">Verifikasi</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-add-product">
        <div class="modal-content">
            <i class="fas fa-times modal-close" onclick="closeModal('modal-add-product')"></i><h2 id="modal-product-title" style="margin-bottom:20px;">Tambah Item Baru</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="p-id" value="">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="input-group"><label class="input-label">SKU / Barcode</label><input type="text" id="p-sku" class="input-field" placeholder="Auto"></div>
                    <div class="input-group"><label class="input-label">Kategori</label><input type="text" id="p-cat" class="input-field" required placeholder="Minuman"></div>
                </div>
                <div class="input-group"><label class="input-label">Nama Produk / Layanan</label><input type="text" id="p-name" class="input-field" required></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="input-group"><label class="input-label">Harga Modal</label><input type="number" id="p-cost" class="input-field" value="0"></div>
                    <div class="input-group"><label class="input-label">Harga Jual</label><input type="number" id="p-price" class="input-field" required></div>
                </div>
                <div style="background:var(--bg-base); padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid var(--border);">
                    <label style="display:flex; align-items:center; gap:10px; font-weight:600; cursor:pointer;">
                        <input type="checkbox" id="p-track" checked onchange="document.getElementById('stock-input-wrapper').style.display = this.checked ? 'block' : 'none'"> Lacak Stok Barang Ini
                    </label>
                    <div id="stock-input-wrapper" style="margin-top:10px;"><label class="input-label">Stok</label><input type="number" id="p-stock" class="input-field" value="0" style="margin:0;"></div>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%;"><i class="fas fa-save"></i> Simpan Item</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-scanner"><div class="modal-content" style="text-align:center;"><i class="fas fa-times modal-close" onclick="closeCameraScanner()"></i><h3 style="margin-bottom:10px;">Scan Barcode/QR</h3><div id="reader-container"><div id="reader"></div></div></div></div>
    <div class="modal-overlay" id="modal-alert"><div class="modal-content" style="max-width:350px; text-align:center;"><div id="alert-icon" style="font-size:3rem; margin-bottom:15px; color:var(--info);"><i class="fas fa-info-circle"></i></div><h3 id="alert-title" style="margin-bottom:10px;">Info</h3><p id="alert-msg" style="color:var(--text-muted); margin-bottom:20px;">Pesan.</p><button class="btn" style="width:100%;" onclick="closeModal('modal-alert')">Oke</button></div></div>
    <div class="modal-overlay" id="modal-confirm"><div class="modal-content" style="max-width:350px; text-align:center;"><div style="font-size:3rem; margin-bottom:15px; color:var(--warning);"><i class="fas fa-exclamation-triangle"></i></div><h3 style="margin-bottom:10px;">Konfirmasi</h3><p id="confirm-msg" style="color:var(--text-muted); margin-bottom:20px;">Yakin?</p><div style="display:flex; gap:10px;"><button class="btn btn-outline" style="flex:1;" onclick="closeModal('modal-confirm')">Batal</button><button class="btn btn-danger" style="flex:1;" id="confirm-yes-btn">Ya, Lanjut</button></div></div></div>
    <div class="modal-overlay" id="modal-prompt"><div class="modal-content" style="max-width:350px;"><h3 id="prompt-title" style="margin-bottom:10px;">Input Data</h3><input type="text" id="prompt-input" class="input-field" style="font-size:1.1rem; font-weight:bold;"><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn btn-outline" style="flex:1;" onclick="closeModal('modal-prompt')">Batal</button><button class="btn btn-success" style="flex:1;" id="prompt-yes-btn">Simpan</button></div></div></div>
    <div class="modal-overlay" id="modal-qr-menu"><div class="modal-content" style="text-align:center; max-width:400px;"><i class="fas fa-times modal-close" onclick="closeModal('modal-qr-menu')"></i><h2 style="margin-bottom:5px;">Self-Order QR</h2><p style="color:var(--text-muted); margin-bottom:20px; font-size:0.9rem;">Scan untuk pesan mandiri.</p><div id="qr-container"></div></div></div>
    <div class="modal-overlay" id="modal-setup-import"><div class="modal-content" style="max-width:400px;"><i class="fas fa-times modal-close" onclick="closeModal('modal-setup-import')"></i><h3 style="margin-bottom:10px;">Import Backup XML</h3><input type="file" id="setup-xml-upload" accept=".xml" style="margin-bottom:15px; display:block; width:100%;"><button class="btn" style="width:100%;" onclick="importXML('replace', 'setup-xml-upload')">Restore Data</button></div></div>

    <div class="modal-overlay" id="modal-payment">
        <div class="modal-content">
            <i class="fas fa-times modal-close" onclick="closeModal('modal-payment')"></i><h2 style="text-align:center; margin-bottom:5px;">Pembayaran</h2>
            <div class="pay-amount-display" id="pay-total-display">Rp 0</div>
            <div class="input-group"><label class="input-label">Metode Pembayaran</label><select id="pay-method" class="input-field" onchange="toggleCashInput()"><option value="CASH">Tunai (Cash)</option><option value="QRIS">QRIS / E-Wallet</option><option value="TRANSFER">Transfer Bank</option></select></div>
            <div id="cash-input-area"><div class="input-group"><label class="input-label">Uang Diterima (Rp) <span style="font-weight:normal; font-size:0.7rem; color:var(--info);">(Tekan Enter utk Bayar)</span></label><input type="number" id="pay-cash-received" class="input-field" style="font-size:1.2rem; font-weight:bold;" oninput="calculateChange()"></div><div class="quick-cash-grid" id="quick-cash-container"></div><div style="display:flex; justify-content:space-between; font-size:1.1rem; font-weight:700; margin-bottom:20px; color:var(--info);"><span>Kembali:</span><span id="pay-change">Rp 0</span></div></div>
            <button class="btn btn-success" id="btn-pay-execute" style="width:100%; padding:15px; font-size:1.1rem;" onclick="processTransaction()"><i class="fas fa-print"></i> Bayar & Cetak</button>
        </div>
    </div>

    <div class="modal-overlay" id="receipt-modal">
        <div class="modal-content">
            <i class="fas fa-times modal-close no-print" onclick="closeReceiptAndReset()"></i>
            <div id="receipt-print-area">
                <div class="rcpt-center"><h3 id="rcpt-store" style="margin:0; font-size:16px;">Toko</h3><div style="font-size:10px; margin-bottom:10px;">Sistem POS Offline</div></div><div class="rcpt-line"></div>
                <div class="rcpt-flex" style="font-size:10px;"><span id="rcpt-date">01/01</span><span id="rcpt-id">TX</span></div><div class="rcpt-line"></div>
                <div id="rcpt-items"></div><div class="rcpt-line"></div>
                <div class="rcpt-flex"><span>Sub</span><span id="rcpt-sub">0</span></div><div class="rcpt-flex"><span>Disc</span><span id="rcpt-disc">0</span></div><div class="rcpt-flex"><span>Tax</span><span id="rcpt-tax">0</span></div><div class="rcpt-line"></div>
                <div class="rcpt-flex" style="font-weight:bold; font-size:14px;"><span>TOTAL</span><span id="rcpt-tot">0</span></div>
                <div class="rcpt-flex"><span><span id="rcpt-method">CASH</span></span><span id="rcpt-pay">0</span></div><div class="rcpt-flex"><span>Kembali</span><span id="rcpt-change">0</span></div><div class="rcpt-line"></div>
                <div class="rcpt-center" style="font-size:10px; margin-top:10px;">Terima kasih!</div>
            </div>
            <button class="btn no-print" style="width:100%; margin-top:15px;" onclick="printReceipt()"><i class="fas fa-print"></i> Cetak Struk Fisik</button>
        </div>
    </div>

    <script>
        /* =========================================
           DATA STRUCTURE, SECURITY & UTILS
        ========================================= */
        let config, products, transactions, kdsQueue, bookings;
        let cart = [];
        let globalDiscount = 0; let currentGrandTotal = 0;
        let confirmActionCb = null; let promptActionCb = null; let adminActionCb = null;

        const rp = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
        function escapeHTML(str) { if(!str) return ""; return str.toString().replace(/[&<>'"]/g, tag => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[tag] || tag)); }
        function generateUID(prefix = '') { return prefix + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase(); }

        /* =========================================
           STORAGE & KDS SYNC ENGINE
        ========================================= */
        function loadLocalData() {
            try {
                config = JSON.parse(localStorage.getItem('pos_config')) || null;
                products = JSON.parse(localStorage.getItem('pos_products')) || [];
                transactions = JSON.parse(localStorage.getItem('pos_tx')) || [];
                kdsQueue = JSON.parse(localStorage.getItem('pos_kds')) || [];
                bookings = JSON.parse(localStorage.getItem('pos_bookings')) || [];
                
                // Mencegah error jika data draf versi lama (tanpa cartId) di-load
                let savedCart = JSON.parse(localStorage.getItem('pos_cart_draft'));
                if(savedCart && Array.isArray(savedCart)) {
                    cart = savedCart.map(item => {
                        if(!item.cartId) item.cartId = generateUID('C-');
                        if(!item.note) item.note = "";
                        return item;
                    });
                }
            } catch (e) {
                sysAlert("Data lokal korup! Sistem memuat sesi kosong. Harap Restore dari XML.", "error");
                config = null; products = []; transactions = []; kdsQueue = []; bookings = []; cart = [];
            }
        }
        
        function safeSave(key, dataObj) { try { localStorage.setItem(key, JSON.stringify(dataObj)); } catch (e) { if(e.name === 'QuotaExceededError') sysAlert("Memori Penuh! Segera Ekspor XML & Reset Pabrik.", "error"); } }

        window.addEventListener('storage', (e) => {
            if(e.key && e.key.startsWith('pos_')) {
                let prevQueueLength = kdsQueue.length;
                loadLocalData();
                if(kdsQueue.length > prevQueueLength) playBeep();
                
                if(document.getElementById('view-kasir').classList.contains('active')) { renderPOSProducts(document.getElementById('pos-search').value); renderStockTable(); }
                if(document.getElementById('view-dapur').classList.contains('active')) { renderKDS(); renderKDSMetrics(); }
                if(document.getElementById('view-stok').classList.contains('active')) { renderStockTable(); renderStockSync(); }
                if(document.getElementById('view-produk').classList.contains('active')) { renderAdminProducts(); renderProductOpname(); }
                if(document.getElementById('view-laporan').classList.contains('active')) { renderReports(); }
                if(document.getElementById('view-booking').classList.contains('active')) { renderBookings(); renderBookingMetrics(); }
            }
        });

        function playBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination); osc.type = 'sine'; osc.frequency.value = 800;
                gain.gain.setValueAtTime(0, ctx.currentTime); gain.gain.linearRampToValueAtTime(1, ctx.currentTime + 0.05); gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
            } catch(e) {}
        }

        /* CUSTOM DATE FILTER LOGIC */
        function toggleCustomDate(type) {
            let val = document.getElementById('filter-' + type).value;
            document.getElementById('custom-date-' + type).style.display = val === 'custom' ? 'flex' : 'none';
            if(type==='laporan') renderReports();
            if(type==='stok') renderStockTable();
            if(type==='kds') renderKDSMetrics();
        }

        function isDateInPeriod(dateStr, period, type) {
            if(!dateStr) return false;
            let d = new Date(dateStr); let now = new Date();
            d.setHours(0,0,0,0); now.setHours(0,0,0,0);
            
            if (period === 'daily') return d.getTime() === now.getTime();
            if (period === 'weekly') { let diff = (now - d) / (1000*60*60*24); return diff >= 0 && diff <= 7; }
            if (period === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            if (period === 'custom') {
                let start = document.getElementById('start-'+type).value; let end = document.getElementById('end-'+type).value;
                if(!start || !end) return true; 
                let sDate = new Date(start); sDate.setHours(0,0,0,0);
                let eDate = new Date(end); eDate.setHours(23,59,59,999);
                let dTime = new Date(dateStr).getTime();
                return dTime >= sDate.getTime() && dTime <= eDate.getTime();
            }
            return true;
        }

        /* =========================================
           PWA SERVICE WORKER
        ========================================= */
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(e=>{}); }); }
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; const el = document.getElementById('pwa-install-container'); if(el) el.style.display = 'block'; });
        function installPWA() { if (!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('pwa-install-container').style.display = 'none'; }); }

        /* =========================================
           INIT & GLOBALS
        ========================================= */
        window.onload = () => {
            loadLocalData();
            if (!config) document.getElementById('setup-screen').style.display = 'flex';
            else startApp();
            
            setInterval(() => { let now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); updateKDSTimers(now); }, 1000);
            
            document.getElementById('pos-search').addEventListener('input', (e) => {
                let val = e.target.value.trim();
                if(val.startsWith('ORD@')) { processCustomerOrder(val); e.target.value = ''; return; }
                renderPOSProducts(val);
            });
        };

        let selectedMode = 'fnb';
        function selectMode(mode, el) { selectedMode = mode; document.querySelectorAll('.mode-card').forEach(btn => btn.classList.remove('active')); el.classList.add('active'); }

        function saveSetup() {
            config = { name: document.getElementById('setup-name').value || "Toko Saya", mode: selectedMode, taxRate: 0, pin: "" }; 
            safeSave('pos_config', config); if(!localStorage.getItem('pos_products')) safeSave('pos_products', []); startApp();
        }

        function startApp() {
            document.getElementById('setup-screen').style.display = 'none'; document.getElementById('app-shell').style.display = 'flex';
            document.body.className = 'mode-' + config.mode;
            document.getElementById('store-title').innerText = escapeHTML(config.name); document.getElementById('store-mode').innerText = config.mode.toUpperCase();
            document.getElementById('setting-tax').value = config.taxRate || 0; document.getElementById('tax-rate-display').innerText = config.taxRate || 0;

            document.querySelectorAll('.mode-specific').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.mode-' + config.mode).forEach(el => el.style.display = 'flex');

            switchView('kasir', document.getElementById('nav-kasir'));
            
            let touchstartX = 0; const cartPanel = document.getElementById('pos-cart-panel');
            cartPanel.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
            cartPanel.addEventListener('touchend', e => { if (e.changedTouches[0].screenX - touchstartX > 50) cartPanel.classList.remove('open'); }, {passive: true});
        }

        /* =========================================
           TAB & VIEW CONTROLLER
        ========================================= */
        function switchView(view, navElement) {
            document.getElementById('pos-cart-panel').classList.remove('open');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            
            if (view === 'dapur') document.body.classList.add('mode-dapur-active'); else document.body.classList.remove('mode-dapur-active');
            if(navElement) { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); navElement.classList.add('active'); }

            if(view === 'kasir') { renderPOSProducts(); renderCart(); }
            if(view === 'produk') { renderAdminProducts(); renderProductOpname(); }
            if(view === 'stok') { renderStockTable(); renderStockSync(); }
            if(view === 'laporan') renderReports();
            if(view === 'dapur') { if(window.innerWidth <= 768) { renderPOSProducts(); renderCart(); } renderKDS(); renderKDSMetrics(); }
            if(view === 'booking') { renderBookings(); renderBookingMetrics(); }
        }

        function switchTab(viewId, tabId, btnElement) {
            document.querySelectorAll(`#${viewId} .tab-btn`).forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`#${viewId} .tab-content`).forEach(c => c.classList.remove('active'));
            btnElement.classList.add('active'); document.getElementById(tabId).classList.add('active');
        }

        function toggleMobileCart() { document.getElementById('pos-cart-panel').classList.toggle('open'); }

        /* =========================================
           CUSTOM ALERTS, MODALS & PIN SYSTEM
        ========================================= */
        function sysAlert(msg, type="info") {
            document.getElementById('alert-msg').innerText = msg; let icon = document.getElementById('alert-icon');
            if(type === 'error') { icon.innerHTML = '<i class="fas fa-times-circle"></i>'; icon.style.color = 'var(--danger)'; document.getElementById('alert-title').innerText = "Error"; }
            else if(type === 'success') { icon.innerHTML = '<i class="fas fa-check-circle"></i>'; icon.style.color = 'var(--success)'; document.getElementById('alert-title').innerText = "Berhasil"; }
            else { icon.innerHTML = '<i class="fas fa-info-circle"></i>'; icon.style.color = 'var(--info)'; document.getElementById('alert-title').innerText = "Info"; }
            document.getElementById('modal-alert').style.display = 'flex';
        }

        function requestConfirm(msg, callback) { document.getElementById('confirm-msg').innerText = msg; confirmActionCb = callback; document.getElementById('modal-confirm').style.display = 'flex'; }
        document.getElementById('confirm-yes-btn').onclick = () => { closeModal('modal-confirm'); if(confirmActionCb) confirmActionCb(); };

        function requestPrompt(title, defaultVal, callback, type="text") {
            document.getElementById('prompt-title').innerText = title; document.getElementById('prompt-input').value = defaultVal; document.getElementById('prompt-input').type = type;
            promptActionCb = callback; document.getElementById('modal-prompt').style.display = 'flex';
            setTimeout(()=> document.getElementById('prompt-input').focus(), 100);
        }
        document.getElementById('prompt-yes-btn').onclick = () => { closeModal('modal-prompt'); if(promptActionCb) promptActionCb(document.getElementById('prompt-input').value); };

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openDiscountPrompt() { requestPrompt("Masukkan total diskon (Rp):", globalDiscount, (val) => { if(!isNaN(val)) { globalDiscount = parseInt(val); renderCart(); } }, "number"); }

        function checkPinAndEnterSettings(navEl) {
            if (!config.pin || config.pin === "") {
                requestPrompt("Buat PIN Admin Baru (Min 4 Angka):", "", (val) => {
                    if(val && val.length >= 4 && !isNaN(val)) { config.pin = val; safeSave('pos_config', config); sysAlert("PIN berhasil dibuat!", "success"); switchView('pengaturan', navEl); } 
                    else { sysAlert("PIN tidak valid. Minimal 4 angka.", "error"); }
                }, "password");
            } else { requireAdmin(() => switchView('pengaturan', navEl)); }
        }

        function requireAdmin(callback) {
            if(!config.pin) return callback();
            adminActionCb = callback; document.getElementById('pin-input').value = ''; document.getElementById('modal-pin').style.display = 'flex';
            setTimeout(()=> document.getElementById('pin-input').focus(), 100);
        }

        function verifyPin() {
            if(document.getElementById('pin-input').value === config.pin) { closeModal('modal-pin'); if(adminActionCb) adminActionCb(); } 
            else { sysAlert("PIN Tidak Valid!", "error"); }
        }

        /* =========================================
           CAMERA SCANNER (HTML5-QRCode)
        ========================================= */
        let html5QrcodeScanner = null;
        function openCameraScanner() {
            document.getElementById('modal-scanner').style.display = 'flex';
            if (!html5QrcodeScanner) {
                try {
                    html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: function(vw, vh) { return { width: Math.floor(Math.min(vw, vh) * 0.8), height: Math.floor(Math.min(vw, vh) * 0.8) }; }, experimentalFeatures: { useBarCodeDetectorIfSupported: true }, rememberLastUsedCamera: true }, false);
                    html5QrcodeScanner.render((decodedText) => {
                        closeCameraScanner();
                        let searchInput = document.getElementById('pos-search'); searchInput.value = decodedText;
                        if (decodedText.startsWith('ORD@')) { processCustomerOrder(decodedText); searchInput.value = ''; } 
                        else { let exactMatch = products.find(p => p.sku === decodedText || p.id.toString() === decodedText); if(exactMatch) { addToCart(exactMatch.id); searchInput.value = ''; } else { renderPOSProducts(decodedText); } }
                    }, (error) => {});
                } catch(e) { sysAlert("Modul Kamera gagal dimuat (cek koneksi/HTTPS).", "error"); }
            }
        }
        function closeCameraScanner() { document.getElementById('modal-scanner').style.display = 'none'; if(html5QrcodeScanner) { try { html5QrcodeScanner.clear(); html5QrcodeScanner = null; } catch(e) {} } }

        /* =========================================
           SELF-ORDER QR & CUSTOMER
        ========================================= */
        function showQRMenu() {
            if(products.length === 0) return sysAlert("Toko belum memiliki produk!", "error");
            const menuData = products.map(p => [p.id, p.name.replace(/[^a-zA-Z0-9 ]/g, '').substring(0,20), p.price, p.trackStock ? p.stock : -1]);
            const storeData = { n: config.name, m: menuData }; const encoded = btoa(encodeURIComponent(JSON.stringify(storeData))); 
            let baseUrl = window.location.href.split('?')[0].replace('pos.html', '').replace('pos', '').replace('#', ''); if(!baseUrl.endsWith('/')) baseUrl += '/';
            const url = baseUrl + 'pos_order.html?data=' + encoded;
            if(url.length > 2000) return sysAlert("Menu terlalu banyak (URL melebihi batas).", "error");
            document.getElementById('qr-container').innerHTML = ''; 
            try { new QRCode(document.getElementById("qr-container"), { text: url, width: 250, height: 250, colorDark : "#0F172A", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.L }); document.getElementById('modal-qr-menu').style.display = 'flex'; } catch(e) { sysAlert("Gagal generate QR Code.", "error"); }
        }

        function processCustomerOrder(code) {
            try {
                // FORMAT BARU: ORD@PRD-123:2:Tanpa%20Es,PRD-456:1
                const items = code.replace('ORD@', '').split(','); let addedCount = 0;
                
                items.forEach(itemStr => {
                    const parts = itemStr.split(':');
                    const idStr = parts[0]; 
                    const qty = parseInt(parts[1]);
                    // Parse catatan pelanggan jika ada (aman terhadap titik dua tambahan)
                    const noteStr = parts.length > 2 ? decodeURIComponent(parts.slice(2).join(':')) : "";
                    
                    const prod = products.find(p => p.id.toString() === idStr);
                    if(prod) { 
                        // Pisahkan per baris jika ada catatan yang unik
                        const existing = cart.find(c => c.id.toString() === idStr && c.note === noteStr); 
                        if(existing) {
                            existing.qty += qty; 
                        } else { 
                            cart.push({ ...prod, cartId: generateUID('C-'), qty: qty, note: noteStr }); 
                        }
                        addedCount++; 
                    }
                });
                
                if(addedCount > 0) { renderCart(); sysAlert(`Berhasil menambah ${addedCount} pesanan dari Pelanggan!`, 'success'); } 
                else { sysAlert('Kode pesanan tidak dikenali.', 'error'); }
            } catch(err) { sysAlert('Format Barcode tidak valid.', 'error'); }
        }

        /* =========================================
           PRODUCT & STOCK MANAGEMENT (WITH EDIT)
        ========================================= */
        function openProductModal(id = null) {
            document.getElementById('modal-add-product').style.display = 'flex';
            if(id) {
                let p = products.find(x => x.id.toString() === id.toString());
                document.getElementById('modal-product-title').innerText = "Edit Item"; document.getElementById('p-id').value = p.id;
                document.getElementById('p-sku').value = p.sku; document.getElementById('p-cat').value = p.category; document.getElementById('p-name').value = p.name; 
                document.getElementById('p-cost').value = p.cost; document.getElementById('p-price').value = p.price; document.getElementById('p-track').checked = p.trackStock;
                document.getElementById('p-stock').value = p.trackStock ? p.stock : 0; document.getElementById('stock-input-wrapper').style.display = p.trackStock ? 'block' : 'none';
            } else {
                document.getElementById('modal-product-title').innerText = "Tambah Item Baru"; document.getElementById('p-id').value = ""; document.getElementById('p-sku').value = ""; document.getElementById('p-cat').value = "";
                document.getElementById('p-name').value = ""; document.getElementById('p-cost').value = 0; document.getElementById('p-price').value = "";
                document.getElementById('p-track').checked = true; document.getElementById('p-stock').value = 0; document.getElementById('stock-input-wrapper').style.display = 'block';
            }
        }

        function saveProduct(e) {
            e.preventDefault();
            const editId = document.getElementById('p-id').value; const sku = document.getElementById('p-sku').value || `SKU-${Math.random().toString(36).substring(2,8).toUpperCase()}`;
            const track = document.getElementById('p-track').checked;
            const prodData = {
                sku: sku, name: document.getElementById('p-name').value, category: document.getElementById('p-cat').value,
                cost: parseInt(document.getElementById('p-cost').value) || 0, price: parseInt(document.getElementById('p-price').value),
                trackStock: track, stock: track ? (parseInt(document.getElementById('p-stock').value) || 0) : null
            };
            if(editId) { let pIndex = products.findIndex(x => x.id.toString() === editId.toString()); if(pIndex !== -1) { products[pIndex] = { ...products[pIndex], ...prodData }; } } 
            else { prodData.id = generateUID('PRD-'); products.push(prodData); }
            safeSave('pos_products', products); e.target.reset(); closeModal('modal-add-product'); 
            renderAdminProducts(); renderStockTable(); renderProductOpname(); renderStockSync(); renderPOSProducts(); sysAlert("Produk berhasil disimpan.", "success");
        }

        function triggerDeleteProduct(id) {
            requireAdmin(() => requestConfirm("Hapus produk ini secara permanen?", () => {
                products = products.filter(p => p.id.toString() !== id.toString()); safeSave('pos_products', products);
                cart = cart.filter(i => i.id.toString() !== id.toString()); renderCart(); renderAdminProducts(); renderStockTable(); renderPOSProducts();
            }));
        }

        function renderAdminProducts() {
            let query = document.getElementById('search-prod').value.toLowerCase();
            let filtered = products;
            if(query) filtered = products.filter(p => p.name.toLowerCase().includes(query) || p.category.toLowerCase().includes(query) || p.sku.toLowerCase().includes(query));
            
            const tbody = document.getElementById('product-table-body');
            if(filtered.length === 0) return tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Data kosong.</td></tr>`;
            tbody.innerHTML = filtered.map(p => `<tr><td style="font-family:monospace;">${escapeHTML(p.sku)}</td><td style="font-weight:600;">${escapeHTML(p.name)}</td><td><span class="badge" style="background:var(--border);">${escapeHTML(p.category)}</span></td><td>${rp(p.cost)}</td><td style="color:var(--success); font-weight:700;">${rp(p.price)}</td><td>${p.trackStock ? p.stock : ''}</td><td style="white-space:nowrap;"><button class="btn btn-sm btn-info" onclick="openProductModal('${p.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger" onclick="triggerDeleteProduct('${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }

        function renderStockTable() {
            let period = document.getElementById('filter-stok').value;
            let txInPeriod = transactions.filter(t => isDateInPeriod(t.date, period, 'stok'));
            const tbody = document.getElementById('stock-table-body');
            if(products.length === 0) return tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Data kosong.</td></tr>`;
            
            tbody.innerHTML = products.map(p => {
                let soldInPeriod = 0; txInPeriod.forEach(t => { let itemSold = t.items.find(i => i.id.toString() === p.id.toString()); if(itemSold) soldInPeriod += itemSold.qty; });
                let btns = p.trackStock ? `<button class="btn btn-sm btn-outline" onclick="triggerAdjustStock('${p.id}', 'in')">+ In</button> <button class="btn btn-sm btn-outline" style="color:var(--danger); border-color:var(--danger);" onclick="triggerAdjustStock('${p.id}', 'out')">- Out</button>` : '-';
                return `<tr><td><div style="font-weight:600;">${escapeHTML(p.name)}</div><div style="font-size:0.75rem; color:var(--text-muted);">${escapeHTML(p.sku)}</div></td><td style="font-weight:bold; font-size:1.1rem;">${p.trackStock ? p.stock : ''}</td><td style="color:var(--info); font-weight:bold;">${soldInPeriod}</td><td style="display:flex; gap:5px;">${btns}</td></tr>`;
            }).join('');
        }

        function triggerAdjustStock(id, type) {
            requestPrompt(`Jumlah barang ${type === 'in' ? 'MASUK' : 'KELUAR'}:`, "1", (val) => {
                let qty = parseInt(val);
                if(qty && !isNaN(qty) && qty > 0) {
                    let p = products.find(x => x.id.toString() === id.toString());
                    if(type === 'out' && p.stock < qty) return sysAlert("Stok tidak mencukupi!", "error");
                    p.stock += (type === 'in' ? qty : -qty); safeSave('pos_products', products); renderStockTable(); renderAdminProducts(); renderPOSProducts();
                }
            }, "number");
        }

        /* =========================================
           POS (KASIR) LOGIC & PERSIST CART
        ========================================= */
        function renderPOSProducts(query = '') {
            const grid = document.getElementById('pos-product-grid'); let filtered = products;
            if(query) filtered = products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()) || p.sku.toLowerCase().includes(query.toLowerCase()));

            let salesCount = {}; transactions.forEach(tx => tx.items.forEach(i => { salesCount[i.id] = (salesCount[i.id] || 0) + i.qty; }));
            filtered.sort((a, b) => (salesCount[b.id] || 0) - (salesCount[a.id] || 0));

            if(filtered.length === 0) return grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px;">Tidak ditemukan.</div>`;
            
            grid.innerHTML = filtered.map((p, index) => {
                let isTop = index < 3 && (salesCount[p.id] || 0) > 0 && query === '';
                let badgeHtml = isTop ? `<div class="best-badge"><i class="fas fa-fire"></i> Best</div>` : '';
                return `<div class="product-card" onclick="addToCart('${p.id}')">${badgeHtml}<div><div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:4px;">${escapeHTML(p.category)}</div><div style="font-weight:600; font-size:0.95rem; line-height:1.2;">${escapeHTML(p.name)}</div></div><div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;"><span style="font-size:0.7rem; color:var(--text-muted);">${p.trackStock ? 'Stok: '+p.stock : 'Jasa'}</span><span style="font-weight:700; color:var(--success);">${rp(p.price)}</span></div></div>`;
            }).join('');
        }

        function addToCart(id) {
            const prod = products.find(p => p.id.toString() === id.toString());
            if(prod.trackStock && prod.stock <= 0) return sysAlert("Stok barang habis!", "error");
            
            const existing = cart.find(item => item.id.toString() === id.toString() && (!item.note || item.note === ""));
            if(existing) { 
                if(prod.trackStock && existing.qty >= prod.stock) return sysAlert("Melebihi stok tersedia!", "error"); 
                existing.qty++; 
            } else { 
                cart.push({ ...prod, cartId: generateUID('C-'), qty: 1, note: "" }); 
            }
            document.getElementById('pos-search').value = ''; renderPOSProducts(); renderCart();
        }

        function updateQty(cartId, delta) {
            const item = cart.find(i => i.cartId === cartId);
            if(item) {
                const prod = products.find(p => p.id.toString() === item.id.toString());
                if(delta > 0 && prod.trackStock && item.qty >= prod.stock) return sysAlert("Stok tidak cukup!", "error");
                item.qty += delta; if(item.qty <= 0) cart = cart.filter(i => i.cartId !== cartId);
                renderCart();
            }
        }

        function addNoteToItem(cartId) {
            let existingItem = cart.find(i => i.cartId === cartId);
            if(!existingItem) return;
            requestPrompt("Catatan Pesanan (misal: Sedikit pedas):", existingItem.note || "", (val) => { 
                existingItem.note = val; 
                renderCart(); 
            }, "text");
        }

        function clearCart() { if(cart.length > 0) { cart = []; globalDiscount = 0; renderCart(); if(window.innerWidth <= 768) document.getElementById('pos-cart-panel').classList.remove('open'); } }

        function renderCart() {
            const list = document.getElementById('cart-list'); let totalQty = cart.reduce((sum, i) => sum + i.qty, 0); safeSave('pos_cart_draft', cart); 
            
            let previewText = "";
            if(cart.length > 0) {
                let itemNames = cart.map(i => escapeHTML(i.name)).reverse().slice(0, 2).join(', '); if(cart.length > 2) itemNames += '...';
                previewText = `<div style="font-size:0.75rem; font-weight:400; opacity:0.9; max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${itemNames}</div>`;
            }
            
            if(cart.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:50px;"><i class="fas fa-shopping-basket" style="font-size:2rem; opacity:0.3;"></i><br>Keranjang Kosong</div>`;
                document.getElementById('cart-subtotal').innerText = rp(0); document.getElementById('cart-tax').innerText = rp(0);
                document.getElementById('cart-discount').innerText = "-Rp 0"; document.getElementById('cart-total').innerText = rp(0);
                document.getElementById('mobile-cart-badge').innerHTML = `0 Item | Rp 0`; return;
            }

            let subtotal = 0;
            list.innerHTML = cart.map(item => {
                subtotal += (item.price * item.qty);
                let noteHtml = item.note ? `<div style="font-size:0.7rem; color:var(--accent); margin-top:2px;"><i class="fas fa-comment-dots"></i> ${escapeHTML(item.note)}</div>` : '';
                return `<div class="cart-item"><div style="flex:1;"><div style="font-weight:600; font-size:0.9rem;">${escapeHTML(item.name)} <span style="color:var(--info); cursor:pointer; margin-left:5px;" onclick="addNoteToItem('${item.cartId}')"><i class="fas fa-edit"></i></span></div><div style="font-size:0.75rem; color:var(--text-muted);">${rp(item.price)}</div>${noteHtml}</div><div class="qty-control"><button class="qty-btn" onclick="updateQty('${item.cartId}', -1)">-</button><span style="font-size:0.85rem; font-weight:600; width:20px; text-align:center;">${item.qty}</span><button class="qty-btn" onclick="updateQty('${item.cartId}', 1)">+</button></div><div style="font-weight:700; width:80px; text-align:right; font-size:0.9rem;">${rp(item.price * item.qty)}</div></div>`;
            }).join('');
            
            const tax = Math.round((subtotal - globalDiscount) * (config.taxRate / 100));
            currentGrandTotal = Math.round(subtotal - globalDiscount + tax);
            
            document.getElementById('cart-subtotal').innerText = rp(subtotal); document.getElementById('cart-discount').innerText = `-`+rp(globalDiscount); document.getElementById('cart-tax').innerText = rp(tax); document.getElementById('cart-total').innerText = rp(currentGrandTotal); document.getElementById('mobile-cart-badge').innerHTML = `<div style="text-align:left;"><div>${totalQty} Item | ${rp(currentGrandTotal)}</div>${previewText}</div>`;
        }

        /* =========================================
           PAYMENT & RECEIPT / PDF
        ========================================= */
        function openPaymentModal() {
            if(cart.length === 0) return sysAlert("Keranjang kosong!", "error");
            document.getElementById('pay-total-display').innerText = rp(currentGrandTotal); document.getElementById('pay-cash-received').value = currentGrandTotal;
            document.getElementById('quick-cash-container').innerHTML = `<div class="quick-cash-btn" onclick="document.getElementById('pay-cash-received').value=${currentGrandTotal}; calculateChange();">Uang Pas</div><div class="quick-cash-btn" onclick="document.getElementById('pay-cash-received').value=50000; calculateChange();">50k</div><div class="quick-cash-btn" onclick="document.getElementById('pay-cash-received').value=100000; calculateChange();">100k</div><div class="quick-cash-btn" onclick="document.getElementById('pay-cash-received').value=''; calculateChange();">Clear</div>`;
            calculateChange(); document.getElementById('modal-payment').style.display = 'flex';
            setTimeout(()=> document.getElementById('pay-cash-received').focus(), 100);
        }

        function toggleCashInput() {
            const method = document.getElementById('pay-method').value; const area = document.getElementById('cash-input-area');
            if(method === 'CASH') { area.style.display = 'block'; document.getElementById('pay-cash-received').value = currentGrandTotal; calculateChange(); setTimeout(()=> document.getElementById('pay-cash-received').focus(), 100); } else { area.style.display = 'none'; }
        }

        function calculateChange() {
            const received = parseInt(document.getElementById('pay-cash-received').value) || 0; const change = received - currentGrandTotal;
            const display = document.getElementById('pay-change');
            if(change < 0) { display.innerText = "Kurang " + rp(Math.abs(change)); display.style.color = "var(--danger)"; } else { display.innerText = rp(change); display.style.color = "var(--success)"; }
        }

        function processTransaction() {
            const method = document.getElementById('pay-method').value;
            const received = method === 'CASH' ? parseInt(document.getElementById('pay-cash-received').value) || 0 : currentGrandTotal;
            if(received < currentGrandTotal) return sysAlert("Uang pembayaran kurang!", "error");

            const txId = generateUID('TX-'); const calculatedTax = Math.round((currentGrandTotal+globalDiscount)*(config.taxRate/100));
            const calculatedProfit = Math.round(cart.reduce((sum, item) => sum + ((item.price - item.cost) * item.qty), 0) - globalDiscount);
            
            const tx = {
                id: txId, date: new Date().toISOString(), items: [...cart], subtotal: Math.round(currentGrandTotal + globalDiscount - calculatedTax),
                discount: globalDiscount, tax: calculatedTax, total: currentGrandTotal, method: method, received: received, change: received - currentGrandTotal, profit: calculatedProfit
            };
            transactions.push(tx); safeSave('pos_tx', transactions);

            cart.forEach(item => { let p = products.find(x => x.id.toString() === item.id.toString()); if(p && p.trackStock) p.stock -= item.qty; }); safeSave('pos_products', products);
            if(config.mode === 'fnb') { kdsQueue.push({ id: txId, time: tx.date, items: tx.items, status: 'pending' }); safeSave('pos_kds', kdsQueue); }

            closeModal('modal-payment'); buildReceipt(tx);
            cart = []; globalDiscount = 0; safeSave('pos_cart_draft', []); 
            renderCart(); renderPOSProducts(); renderStockTable(); renderReports(); renderKDS(); renderKDSMetrics();
            if(window.innerWidth <= 768) { document.getElementById('pos-cart-panel').classList.remove('open'); }
        }

        function buildReceipt(tx) {
            document.getElementById('rcpt-store').innerText = escapeHTML(config.name); document.getElementById('rcpt-date').innerText = new Date(tx.date).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'2-digit'}); document.getElementById('rcpt-id').innerText = tx.id.split('-')[1];
            
            document.getElementById('rcpt-items').innerHTML = tx.items.map(i => {
                let nameHtml = `<div style="font-size:11px; max-width:100%; word-wrap:break-word;">${escapeHTML(i.name)}</div>`;
                let noteHtml = i.note ? `<div style="font-size:9px; padding-left:5px; font-style:italic;">* ${escapeHTML(i.note)}</div>` : '';
                let detailHtml = `<div class="rcpt-flex" style="font-size:10px;"><span>${i.qty} x ${rp(i.price)}</span><span>${rp(i.qty * i.price)}</span></div>`;
                return nameHtml + noteHtml + detailHtml;
            }).join('');
            
            document.getElementById('rcpt-sub').innerText = rp(tx.subtotal); document.getElementById('rcpt-disc').innerText = rp(tx.discount); document.getElementById('rcpt-tax').innerText = rp(tx.tax);
            document.getElementById('rcpt-tot').innerText = rp(tx.total); document.getElementById('rcpt-method').innerText = tx.method; document.getElementById('rcpt-pay').innerText = rp(tx.received); document.getElementById('rcpt-change').innerText = rp(tx.change); document.getElementById('receipt-modal').style.display = 'flex';
        }

        function printReceipt() { document.body.classList.add('print-receipt'); window.print(); setTimeout(() => document.body.classList.remove('print-receipt'), 1000); }
        function printReportPDF() { document.body.classList.add('print-report'); window.print(); setTimeout(() => document.body.classList.remove('print-report'), 1000); }
        function reprintInvoice(txId) { const tx = transactions.find(t => t.id === txId); if(tx) buildReceipt(tx); }
        function closeReceiptAndReset() { closeModal('receipt-modal'); document.getElementById('pos-search').focus(); }

        /* =========================================
           KDS (DAPUR) TIMER & METRICS
        ========================================= */
        function renderKDS() {
            const cont = document.getElementById('kds-container'); const pending = kdsQueue.filter(q => q.status === 'pending');
            if(pending.length === 0) return cont.innerHTML = "<div style='grid-column:1/-1; text-align:center; padding:50px; color:var(--text-muted);'>Tidak ada antrian masak.</div>";
            cont.innerHTML = pending.map(q => `<div class="kds-ticket"><div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;"><span>#${q.id.split('-')[1]}</span><span class="kds-timer badge" data-time="${q.time}" style="background:var(--danger-soft); color:var(--danger);">00:00</span></div><ul style="padding-left:20px; font-size:0.9rem; margin-bottom:15px; flex:1;">${q.items.map(i => `<li><b>${i.qty}x</b> ${escapeHTML(i.name)} ${i.note ? `<br><small style="color:var(--accent)">* ${escapeHTML(i.note)}</small>` : ''}</li>`).join('')}</ul><button class="btn btn-outline" style="width:100%; border-color:var(--success); color:var(--success);" onclick="markKdsDone('${q.id}')"><i class="fas fa-check"></i> Selesai Masak</button></div>`).reverse().join('');
        }

        function updateKDSTimers(now) {
            document.querySelectorAll('.kds-timer').forEach(el => {
                let orderTime = new Date(el.getAttribute('data-time')); let diffSecs = Math.floor((now - orderTime) / 1000);
                let m = Math.floor(diffSecs / 60); let s = diffSecs % 60; el.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if(m >= 15) { el.style.background = 'var(--danger)'; el.style.color = 'white'; } else if (m >= 5) { el.style.background = 'var(--warning)'; el.style.color = 'white'; }
            });
        }

        function markKdsDone(id) { let q = kdsQueue.find(x => x.id === id); if(q) { q.status = 'done'; q.doneTime = new Date().toISOString(); safeSave('pos_kds', kdsQueue); renderKDS(); renderKDSMetrics(); } }

        function renderKDSMetrics() {
            let period = document.getElementById('filter-kds').value; let doneInPeriod = kdsQueue.filter(q => q.status === 'done' && isDateInPeriod(q.time, period, 'kds'));
            document.getElementById('kds-done-count').innerText = doneInPeriod.length;
            if(doneInPeriod.length > 0) {
                let totalMins = doneInPeriod.reduce((sum, q) => sum + Math.floor((new Date(q.doneTime) - new Date(q.time))/60000), 0);
                document.getElementById('kds-avg-time').innerText = Math.round(totalMins / doneInPeriod.length) + "m";
            } else { document.getElementById('kds-avg-time').innerText = "0m"; }

            let menuStats = {};
            doneInPeriod.forEach(q => { q.items.forEach(item => { if(menuStats[item.id]) menuStats[item.id].qty += item.qty; else menuStats[item.id] = { name: item.name, category: item.category, qty: item.qty }; }); });
            let opnameHTML = Object.values(menuStats).sort((a,b) => b.qty - a.qty).map(m => `<tr><td style="font-weight:600;">${escapeHTML(m.name)}</td><td>${escapeHTML(m.category)}</td><td style="color:var(--success); font-weight:bold;">${m.qty} Porsi</td></tr>`).join('');
            if(!opnameHTML) opnameHTML = `<tr><td colspan="3" style="text-align:center;">Belum ada data di periode ini.</td></tr>`;
            document.getElementById('kds-opname-body').innerHTML = opnameHTML;
        }

        /* =========================================
           OPNAME & REVIEW PRODUK/STOK
        ========================================= */
        function renderProductOpname() {
            let physicalItems = products.filter(p => p.trackStock); document.getElementById('opn-total-item').innerText = products.length;
            document.getElementById('opn-total-cost').innerText = rp(physicalItems.reduce((sum, p) => sum + (p.cost * p.stock), 0)); document.getElementById('opn-total-value').innerText = rp(physicalItems.reduce((sum, p) => sum + (p.price * p.stock), 0));
            document.getElementById('opn-asset-body').innerHTML = physicalItems.map(p => `<tr><td style="font-weight:600;">${escapeHTML(p.name)}</td><td>${p.stock}</td><td>${rp(p.cost * p.stock)}</td><td style="color:var(--success); font-weight:bold;">${rp(p.price * p.stock)}</td></tr>`).join('');
        }

        function renderStockSync() {
            let physicalItems = products.filter(p => p.trackStock);
            if(physicalItems.length === 0) return document.getElementById('stok-sync-body').innerHTML = `<tr><td colspan="4" style="text-align:center;">Tidak ada produk fisik.</td></tr>`;
            document.getElementById('stok-sync-body').innerHTML = physicalItems.map(p => `<tr><td style="font-weight:600;">${escapeHTML(p.name)}</td><td>${p.stock}</td><td><input type="number" id="sync-val-${p.id}" class="input-field" style="padding:6px; margin:0; max-width:100px;" value="${p.stock}"></td><td><button class="btn btn-sm btn-info" onclick="syncStock('${p.id}')">Sync</button></td></tr>`).join('');
        }

        function syncStock(id) {
            let val = parseInt(document.getElementById(`sync-val-${id}`).value); if(isNaN(val)) return sysAlert("Masukkan angka valid", "error");
            let p = products.find(x => x.id.toString() === id.toString()); p.stock = val; safeSave('pos_products', products); sysAlert(`Stok ${p.name} disesuaikan menjadi ${val}.`, "success");
            renderStockTable(); renderStockSync(); renderProductOpname();
        }

        /* =========================================
           SMART BOOKING & RESERVASI
        ========================================= */
        function saveBooking(e) {
            e.preventDefault(); bookings.push({ id: generateUID('BK-'), name: document.getElementById('b-name').value, date: document.getElementById('b-date').value, time: document.getElementById('b-time').value, service: document.getElementById('b-service').value, status: 'Scheduled' });
            safeSave('pos_bookings', bookings); e.target.reset(); closeModal('modal-add-booking'); renderBookings(); renderBookingMetrics(); sysAlert("Reservasi disimpan.", "success");
        }

        function renderBookings() {
            const tbody = document.getElementById('booking-table-body');
            if(bookings.length === 0) return tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Tidak ada jadwal.</td></tr>`;
            let sorted = [...bookings].sort((a,b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
            tbody.innerHTML = sorted.map(b => {
                let statBadge = b.status === 'Scheduled' ? `<span class="badge badge-warning">Terjadwal</span>` : `<span class="badge badge-info">${b.status}</span>`;
                return `<tr><td style="font-weight:600;">${b.date} <br><span style="color:var(--accent);">${b.time}</span></td><td><div style="font-weight:bold;">${escapeHTML(b.name)}</div><div style="font-size:0.8rem; color:var(--text-muted);">${escapeHTML(b.service)}</div></td><td>${statBadge}<div style="font-size:0.75rem; margin-top:4px;">${b.checkInDetail || '-'}</div></td><td>${b.status === 'Scheduled' ? `<button class="btn btn-sm btn-outline" style="color:var(--success); border-color:var(--success);" onclick="checkInBooking('${b.id}')"><i class="fas fa-check"></i> Check-in</button>` : ''} <button class="btn btn-sm" style="background:transparent; color:var(--danger);" onclick="requestConfirm('Hapus jadwal?', ()=>deleteBooking('${b.id}'))"><i class="fas fa-trash"></i></button></td></tr>`;
            }).join('');
        }

        function checkInBooking(id) {
            let b = bookings.find(x => x.id === id);
            if(b) {
                let scheduled = new Date(`${b.date}T${b.time}`); let diffMins = Math.floor((new Date() - scheduled) / 60000);
                b.status = 'Selesai'; if(diffMins < -15) b.checkInDetail = `Datang Awal (${Math.abs(diffMins)}m)`; else if(diffMins > 15) b.checkInDetail = `Terlambat (${diffMins}m)`; else b.checkInDetail = `Tepat Waktu`;
                safeSave('pos_bookings', bookings); renderBookings(); renderBookingMetrics(); sysAlert("Pelanggan Check-in: " + b.checkInDetail, "success");
            }
        }

        function renderBookingMetrics() { document.getElementById('book-total').innerText = bookings.length; document.getElementById('book-ontime').innerText = bookings.filter(b => b.checkInDetail && (b.checkInDetail.includes('Tepat') || b.checkInDetail.includes('Awal'))).length; document.getElementById('book-late').innerText = bookings.filter(b => b.checkInDetail && b.checkInDetail.includes('Terlambat')).length; }
        function deleteBooking(id) { bookings = bookings.filter(x => x.id !== id); safeSave('pos_bookings', bookings); renderBookings(); renderBookingMetrics(); }

        /* =========================================
           REPORTS & DB MANAGEMENT
        ========================================= */
        function renderReports() {
            let period = document.getElementById('filter-laporan').value; 
            let query = document.getElementById('search-tx').value.toLowerCase();
            let txInPeriod = transactions.filter(t => isDateInPeriod(t.date, period, 'laporan'));
            
            // Filter Search ID / Metode
            if(query) txInPeriod = txInPeriod.filter(t => t.id.toLowerCase().includes(query) || t.method.toLowerCase().includes(query));

            document.getElementById('report-omzet').innerText = rp(txInPeriod.reduce((sum, t) => sum + t.total, 0)); document.getElementById('report-tx-count').innerText = txInPeriod.length; document.getElementById('report-laba').innerText = rp(txInPeriod.reduce((sum, t) => sum + (t.profit || 0), 0));
            let tbody = document.getElementById('tx-history-body');
            if(txInPeriod.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Tidak ada transaksi di periode ini.</td></tr>`; } 
            else { tbody.innerHTML = txInPeriod.slice().reverse().map(t => `<tr><td style="font-family:monospace;">${t.id.split('-')[1]}</td><td>${new Date(t.date).toLocaleTimeString('id-ID', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'})}</td><td>${t.items.reduce((sum,i)=>sum+i.qty,0)} Item</td><td><span class="badge" style="background:var(--border);">${t.method}</span></td><td style="font-weight:bold; color:var(--success);">${rp(t.total)}</td><td class="no-print"><button style="background:none; border:none; color:var(--info); cursor:pointer;" onclick="reprintInvoice('${t.id}')"><i class="fas fa-print"></i></button></td></tr>`).join(''); }
        }

        function saveSettings() { 
            config.taxRate = parseFloat(document.getElementById('setting-tax').value) || 0; 
            let newPin = document.getElementById('setting-pin').value;
            if(newPin && newPin.length >= 4 && !isNaN(newPin)) { config.pin = newPin; }
            safeSave('pos_config', config); sysAlert("Pengaturan disimpan.", "success"); document.getElementById('setting-pin').value = ''; startApp(); 
        }
        
        function resetApp() { localStorage.clear(); location.reload(); }

        /* =========================================
           XML DATA ENGINE (IMPORT/EXPORT/MERGE)
        ========================================= */
        function exportXML() {
            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<AnsoriPOSBackup date="${new Date().toISOString()}">\n`;
            ['pos_config', 'pos_products', 'pos_tx', 'pos_kds', 'pos_bookings'].forEach(k => { if(localStorage.getItem(k)) xml += `  <data key="${k}">${localStorage.getItem(k).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</data>\n`; });
            xml += `</AnsoriPOSBackup>`;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([xml], { type: "text/xml" })); a.download = `Backup_POS_${Date.now()}.xml`; a.click();
        }
        
        function importXML(mode, inputId) {
            const file = document.getElementById(inputId).files[0]; if(!file) return sysAlert("Pilih file XML terlebih dahulu.", "error");
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const doc = new DOMParser().parseFromString(e.target.result, "text/xml");
                    if(doc.getElementsByTagName("AnsoriPOSBackup").length === 0) throw new Error("Invalid");
                    const nodes = doc.getElementsByTagName("data");
                    if(mode === 'replace') { localStorage.clear(); for(let i=0; i<nodes.length; i++) localStorage.setItem(nodes[i].getAttribute("key"), nodes[i].textContent); } 
                    else if (mode === 'merge') {
                        for(let i=0; i<nodes.length; i++) {
                            const key = nodes[i].getAttribute("key"); if(key === 'pos_config') continue; 
                            const newVal = JSON.parse(nodes[i].textContent); let oldVal = JSON.parse(localStorage.getItem(key)) || [];
                            const merged = [...oldVal]; newVal.forEach(nItem => { if(!merged.find(oItem => oItem.id === nItem.id)) merged.push(nItem); });
                            localStorage.setItem(key, JSON.stringify(merged));
                        }
                    }
                    sysAlert("Data berhasil dimuat! Merestart sistem...", "success"); setTimeout(()=>location.reload(), 1500);
                } catch (err) { sysAlert("File rusak atau tidak valid.", "error"); }
            }; reader.readAsText(file);
        }

        // Global Shortcuts (Void = F4 tanpa PIN)
        document.addEventListener('keydown', (e) => {
            if(e.key === 'F2') { e.preventDefault(); document.getElementById('pos-search').focus(); }
            if(e.key === 'F4') { e.preventDefault(); requestConfirm('Void pesanan ini?', clearCart); }
            if(e.key === 'F9') { e.preventDefault(); if(document.getElementById('view-kasir').classList.contains('active')) openPaymentModal(); }
            
            // Enter execution for Modals
            if(e.key === 'Enter') {
                if(document.getElementById('modal-payment').style.display === 'flex') {
                    e.preventDefault(); document.getElementById('btn-pay-execute').click();
                } else if(document.getElementById('modal-prompt').style.display === 'flex') {
                    e.preventDefault(); document.getElementById('prompt-yes-btn').click();
                }
            }
        });
    </script>
</body>
</html>
