<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quran</title>
    <meta name="description" content="Read the Quran with translation, audio, and prayer times.">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Quran">
    <meta name="theme-color" content="#FFFFFF">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/17187/17187224.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/17187/17187224.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/adhan@4.4.1/lib/Adhan.js"></script>

    <style>
        :root {
            --bg-base: #FFFCF5;
            --bg-surface: #FFFFFF;
            --primary: #059669; 
            --primary-soft: #D1FAE5;
            --accent: #D97706; 
            --text-main: #1C1917;
            --text-muted: #57534E;
            --border: #E7E5E4;
            --font-ui: 'Plus Jakarta Sans', sans-serif;
            --font-ar: 'Amiri', serif;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-base);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 320px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 30;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: var(--safe-top);
            position: relative; 
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-surface);
        }

        .app-title { font-weight: 700; font-size: 1.4rem; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 20px;}
        
        .close-sidebar-btn {
            display: none;
            position: absolute; top: 20px; right: 20px;
            background: var(--bg-base); width: 36px; height: 36px;
            border-radius: 50%; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 1.1rem; cursor: pointer;
            border: 1px solid var(--border);
        }

        /* Widgets */
        .widget-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; letter-spacing: 0.5px; font-weight: 700; }
        
        .time-widget {
            background: var(--bg-base); padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;
        }
        .time-now { font-weight: 700; color: var(--text-main); font-size: 1.1rem; }
        .prayer-badge { 
            font-size: 0.75rem; background: var(--primary-soft); color: var(--primary); 
            padding: 4px 8px; border-radius: 6px; font-weight: 700;
        }

        .location-widget {
            background: #F0FDF4; padding: 12px; border-radius: 12px; border: 1px solid var(--primary-soft);
            display: flex; align-items: center; gap: 10px; color: var(--primary); margin-bottom: 15px;
        }
        .location-text { font-size: 0.85rem; font-weight: 600; }

        /* Mobile Qibla Button (Sidebar) */
        .mobile-qibla-item {
            display: none; /* Hidden on desktop */
            background: var(--bg-base); padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            align-items: center; gap: 10px; cursor: pointer; margin-bottom: 15px; color: var(--accent); font-weight: 600;
        }

        #last-read-card {
            background: var(--primary); color: white; padding: 15px;
            border-radius: 12px; cursor: pointer; display: none; transition: 0.2s; box-shadow: var(--shadow);
        }
        #last-read-card:active { transform: scale(0.98); }
        .lr-label { font-size: 0.7rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .lr-val { font-weight: 700; font-size: 1rem; margin-top: 4px; }

        .search-box { padding: 15px; border-bottom: 1px solid var(--border); }
        .search-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; background: var(--bg-base); outline: none; }
        .search-input:focus { border-color: var(--primary); }

        .surah-list { flex: 1; overflow-y: auto; padding: 10px; padding-bottom: calc(20px + var(--safe-bottom)); }
        .surah-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; margin-bottom: 4px;
        }
        .surah-item:hover { background: var(--bg-base); }
        .surah-item.active { background: var(--primary-soft); border-color: var(--primary-soft); }
        .surah-item.active .s-num { background: var(--primary); color: white; border-color: var(--primary); }
        
        .s-num { 
            width: 32px; height: 32px; background: var(--bg-base); color: var(--text-muted); 
            border-radius: 8px; display: flex; align-items: center; justify-content: center; 
            font-size: 0.8rem; font-weight: 700; margin-right: 12px; border: 1px solid var(--border);
        }
        .s-info h4 { font-size: 0.95rem; margin-bottom: 2px; }
        .s-info span { font-size: 0.75rem; color: var(--text-muted); }
        .s-arabic { font-family: var(--font-ar); font-size: 1.2rem; color: var(--primary); }

        /* --- MAIN CONTENT --- */
        main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; background: var(--bg-base); }

        header {
            height: calc(64px + var(--safe-top));
            padding-top: var(--safe-top);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding-left: 15px; padding-right: 15px; justify-content: space-between;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 10;
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; }
        .toggle-menu { display: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); padding: 5px; }
        .surah-title { font-weight: 700; font-size: 1.1rem; }

        .mobile-clock {
            display: none; font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
            background: var(--bg-surface); padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border);
            margin-right: 10px; align-items: center; gap: 6px;
        }
        .mobile-clock span { color: var(--text-main); font-weight: 700; }

        .lang-switch { display: flex; border: 1px solid var(--border); border-radius: 20px; overflow: hidden; background: var(--bg-surface); }
        .lang-btn {
            background: transparent; border: none; padding: 6px 12px; 
            font-size: 0.75rem; font-weight: 700; cursor: pointer; color: var(--text-muted); transition: 0.2s;
        }
        .lang-btn.active { background: var(--text-main); color: white; }

        .qibla-btn {
            background: var(--bg-surface); border: 1px solid var(--border); color: var(--accent);
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-right: 10px; transition: 0.2s;
        }
        .qibla-btn:active { transform: scale(0.9); background: var(--accent); color: white; }

        /* Reader Area */
        #reader { 
            flex: 1; overflow-y: auto; 
            padding: 20px; padding-bottom: calc(80px + var(--safe-bottom)); /* Extra space for fixed footer */
            scroll-behavior: smooth; 
        }
        
        .bismillah {
            text-align: center; font-family: var(--font-ar); font-size: 2.2rem;
            color: var(--text-main); margin: 30px 0 50px 0; display: none;
        }

        .ayah-card {
            background: var(--bg-surface); border-bottom: 1px solid var(--border);
            padding: 35px 15px; transition: background 0.3s; border-radius: 0;
        }
        .ayah-card:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .ayah-card:last-child { border-bottom: none; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .ayah-card.playing { background: var(--primary-soft); }

        .ayah-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .ayah-num { font-size: 0.75rem; color: var(--text-muted); background: var(--bg-base); padding: 4px 8px; border-radius: 6px; font-weight: 600;}
        
        .ayah-actions button {
            background: none; border: none; cursor: pointer; color: var(--text-muted);
            font-size: 1.1rem; margin-left: 15px; transition: 0.2s;
        }
        .ayah-actions button:hover { color: var(--primary); transform: scale(1.1); }

        .ayah-arabic {
            text-align: right; font-family: var(--font-ar); font-size: 2.4rem;
            line-height: 2.4; color: #000; margin-bottom: 15px; direction: rtl;
        }
        .ayah-latin {
            text-align: left; font-size: 1rem; color: var(--accent);
            margin-bottom: 10px; font-family: 'Times New Roman', serif; font-style: italic; line-height: 1.5; font-weight: 500;
        }
        .ayah-trans { font-size: 1rem; color: var(--text-muted); line-height: 1.6; }

        .loader { display: flex; justify-content: center; align-items: center; height: 100%; color: var(--primary); font-size: 1.5rem; flex-direction: column; gap: 15px; }

        /* Empty State */
        #empty-state { text-align: center; margin-top: 5vh; color: var(--text-muted); padding: 0 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .prayer-table { width: 100%; margin-top: 30px; background: var(--bg-surface); border-radius: 16px; overflow: hidden; border: 1px solid var(--border); }
        .prayer-row { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .prayer-row:last-child { border-bottom: none; }
        .prayer-row.highlight { background: var(--primary-soft); color: var(--primary); font-weight: 700; }

        /* Floating Footer */
        .reader-footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-top: 1px solid var(--border);
            padding: 12px; padding-bottom: calc(12px + var(--safe-bottom));
            text-align: center; font-size: 0.85rem; color: var(--text-muted);
            z-index: 20; display: none;
        }
        .reader-footer a { color: var(--text-main); font-weight: 700; text-decoration: none; }
        .reader-footer i { color: #ef4444; margin: 0 4px; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 100; opacity: 0; visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s ease; backdrop-filter: blur(4px);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background: white; width: 85%; max-width: 320px; padding: 30px;
            border-radius: 24px; text-align: center; transform: translateY(20px);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); position: relative;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-close-icon { position: absolute; top: 15px; right: 15px; cursor: pointer; color: var(--text-muted); font-size: 1.2rem; }
        
        .modal-icon {
            width: 60px; height: 60px; background: var(--primary-soft); color: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin: 0 auto 15px auto;
        }
        .modal-title { font-weight: 700; font-size: 1.2rem; margin-bottom: 8px; color: var(--text-main); }
        .modal-text { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; line-height: 1.5; }
        .modal-btn {
            background: var(--primary); color: white; border: none; padding: 14px 24px;
            border-radius: 100px; width: 100%; font-weight: 600; cursor: pointer; font-size: 1rem;
            transition: transform 0.2s;
        }
        .modal-btn:active { transform: scale(0.98); }

        /* Compass */
        .compass-container { position: relative; width: 200px; height: 200px; margin: 20px auto; }
        .compass-disc { width: 100%; height: 100%; border-radius: 50%; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Compass_Rose_English_North.svg/1024px-Compass_Rose_English_North.svg.png') no-repeat center center; background-size: cover; transition: transform 0.1s ease-out; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .kaaba-pointer { 
            position: absolute; top: 50%; left: 50%; width: 4px; height: 90px; 
            background: var(--accent); transform-origin: bottom center; 
            transform: translate(-50%, -100%) rotate(0deg); z-index: 5; border-radius: 4px;
        }
        .kaaba-pointer::after {
            content: ''; position: absolute; top: -10px; left: -6px; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid var(--accent);
        }

        @media (max-width: 900px) {
            aside { position: absolute; height: 100%; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.1); width: 85%; max-width: 320px; }
            aside.open { transform: translateX(0); }
            .toggle-menu { display: block; }
            .close-sidebar-btn { display: flex; }
            .ayah-arabic { font-size: 2rem; }
            
            /* Clean Sidebar on Mobile */
            .time-widget, .location-widget, .widget-label { display: none; }
            .mobile-qibla-item { display: flex; }
            
            /* Header adjustments */
            .mobile-clock { display: flex; }
            .qibla-btn { display: none; } /* Hide header qibla, show in sidebar */
            .surah-title { font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
        }
    </style>
</head>
<body>

    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="close-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></div>
            <div class="app-title">
                <i class="fas fa-quran"></i> <span data-i18n="appTitle">Quran</span>
            </div>
            
            <div class="widget-label">Time & Prayer</div>
            <div class="time-widget">
                <div style="display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-clock" style="color:var(--text-muted);"></i>
                    <span class="clock-display time-now">--:--</span>
                </div>
                <div class="prayer-badge" id="prayer-desktop">...</div>
            </div>

            <div class="widget-label">Location</div>
            <div class="location-widget">
                <i class="fas fa-map-marker-alt"></i>
                <span id="user-location" class="location-text">Detecting...</span>
            </div>

            <div class="mobile-qibla-item" onclick="openQibla()">
                <i class="far fa-compass"></i>
                <span>Qibla Finder</span>
            </div>

            <div id="last-read-card" onclick="loadLastRead()">
                <div class="lr-label"><i class="fas fa-bookmark"></i> <span data-i18n="lastRead">Last Reading</span></div>
                <div class="lr-val" id="lr-text">--</div>
            </div>
        </div>
        
        <div class="search-box">
            <input type="text" id="search" class="search-input" placeholder="Search Surah..." onkeyup="filterSurahs()">
        </div>

        <div class="surah-list" id="surah-list-container"></div>
    </aside>

    <main>
        <header>
            <div class="header-left">
                <div class="toggle-menu" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
                <h3 class="surah-title" id="header-title" data-i18n="selectSurah">Select Surah</h3>
            </div>
            
            <div style="display: flex; gap: 8px; align-items: center;">
                <div class="mobile-clock">
                    <span class="clock-display">--:--</span>
                    <div style="width:1px; height:12px; background:var(--border);"></div>
                    <span id="prayer-mobile" style="color:var(--primary); font-size:0.7rem;">...</span>
                </div>

                <button class="qibla-btn" onclick="openQibla()" title="Qibla Finder">
                    <i class="far fa-compass"></i>
                </button>

                <div id="audio-status" style="font-size:0.8rem; color:var(--primary); font-weight:700; display:none;">
                    <i class="fas fa-volume-up"></i>
                </div>
                
                <div class="lang-switch">
                    <button class="lang-btn" id="btn-id" onclick="switchLang('id')">ID</button>
                    <button class="lang-btn active" id="btn-en" onclick="switchLang('en')">EN</button>
                </div>
            </div>
        </header>

        <div id="reader">
            <div class="loader" id="loader" style="display:none;">
                <i class="fas fa-circle-notch fa-spin"></i>
                <span style="font-size:0.9rem; color:var(--text-muted);">Fetching Data...</span>
            </div>
            
            <div id="empty-state">
                <i class="fas fa-mosque" style="font-size:3rem; color:var(--primary); opacity:0.3; margin-bottom:20px;"></i>
                <h2 style="font-size:1.5rem; margin-bottom:10px;">Jadwal Sholat</h2>
                <p id="prayer-loc-display" style="font-size:0.9rem; margin-bottom:20px;">Loading Location...</p>
                <div class="prayer-table" id="prayer-table-body">
                    <div style="padding:20px;">Loading times...</div>
                </div>
            </div>

            <div class="bismillah" id="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>
            <div id="ayah-container"></div>
        </div>

        <div class="reader-footer" id="app-footer">
            Built with <i class="fas fa-heart"></i> by <a href="https://ahmadansori.com" target="_blank">Ahmad Ansori</a>
        </div>
    </main>

    <div class="modal-overlay" id="save-modal" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-close-icon" onclick="document.getElementById('save-modal').classList.remove('active')"><i class="fas fa-times"></i></div>
            <div class="modal-icon"><i class="fas fa-check"></i></div>
            <h3 class="modal-title" data-i18n="savedTitle">Saved!</h3>
            <p class="modal-text" id="modal-msg">Progress saved.</p>
            <button class="modal-btn" onclick="document.getElementById('save-modal').classList.remove('active')" data-i18n="continueBtn">Continue Reading</button>
        </div>
    </div>

    <div class="modal-overlay" id="qibla-modal" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-close-icon" onclick="document.getElementById('qibla-modal').classList.remove('active')"><i class="fas fa-times"></i></div>
            <h3 class="modal-title">Qibla Finder</h3>
            <p class="modal-text" style="margin-bottom:10px;">Align the needle to face the Kaaba.</p>
            
            <div class="compass-container">
                <div class="compass-disc" id="compass-disc"></div>
                <div class="kaaba-pointer" id="kaaba-pointer"></div>
            </div>

            <button class="modal-btn" id="start-compass-btn" onclick="initCompass()">Start Compass</button>
            <div id="compass-status" style="font-size:0.8rem; color:var(--text-muted); margin-top:10px;">Requires device sensors</div>
        </div>
    </div>

    <audio id="quran-audio"></audio>

    <script>
        // --- INDONESIAN SURAH NAMES ---
        const surahID = ["Pembukaan", "Sapi Betina", "Keluarga Imran", "Wanita", "Hidangan", "Binatang Ternak", "Tempat Tertinggi", "Harta Rampasan Perang", "Pengampunan", "Yunus", "Hud", "Yusuf", "Guruh", "Ibrahim", "Hijr", "Lebah", "Perjalanan Malam", "Gua", "Maryam", "Thaha", "Para Nabi", "Haji", "Orang-Orang Mukmin", "Cahaya", "Pembeda", "Para Penyair", "Semut", "Kisah-Kisah", "Laba-Laba", "Romawi", "Luqman", "Sajdah", "Golongan Bersekutu", "Saba'", "Pencipta", "Yasin", "Barisan-Barisan", "Sad", "Rombongan", "Orang Beriman", "Yang Dijelaskan", "Musyawarah", "Perhiasan", "Kabut", "Yang Berlutut", "Bukit Pasir", "Muhammad", "Kemenangan", "Kamar-Kamar", "Qaf", "Angin yang Menerbangkan", "Bukit", "Bintang", "Bulan", "Yang Maha Pemurah", "Hari Kiamat", "Besi", "Wanita yang Menggugat", "Pengusiran", "Wanita yang Diuji", "Barisan", "Jumat", "Orang-Orang Munafik", "Hari Dinampakkan Kesalahan", "Talak", "Pengharaman", "Kerajaan", "Pena", "Hari Kiamat", "Tempat-Tempat Naik", "Nuh", "Jin", "Orang yang Berselimut", "Orang yang Berkemul", "Hari Kiamat", "Manusia", "Malaikat-Malaikat", "Berita Besar", "Malaikat Pencabut", "Bermuka Masam", "Penggulungan", "Terbelah", "Orang-Orang Curang", "Terbelah", "Gugusan Bintang", "Yang Datang di Malam Hari", "Yang Paling Tinggi", "Hari Pembalasan", "Fajar", "Negeri", "Matahari", "Malam", "Waktu Duha", "Kelapangan", "Buah Tin", "Segumpal Darah", "Kemuliaan", "Bukti", "Kegoncangan", "Kuda Perang", "Hari Kiamat", "Bermegah-Megahan", "Masa", "Pengumpat", "Gajah", "Quraisy", "Barang-Barang Berguna", "Nikmat yang Banyak", "Orang-Orang Kafir", "Pertolongan", "Gejolak Api", "Ikhlas", "Waktu Subuh", "Manusia"];

        // --- CONFIG ---
        const API_BASE = "https://api.alquran.cloud/v1";
        const PRAYER_API = "https://api.aladhan.com/v1/timings";
        let allSurahs = [];
        let currentSurahMeta = null;
        let currentLang = localStorage.getItem('quran_lang') || 'en';
        let prayerTimings = null;
        let userCoords = { lat: -6.2, lng: 106.8 };

        const i18n = {
            en: {
                appTitle: "Quran", searchPlaceholder: "Search Surah...", lastRead: "Last Reading", selectSurah: "Select Surah", savedTitle: "Saved!", savedMsg: "Surah {s}, Ayah {a} saved.", continueBtn: "Continue Reading"
            },
            id: {
                appTitle: "Al-Quran", searchPlaceholder: "Cari Surah...", lastRead: "Terakhir Dibaca", selectSurah: "Pilih Surah", savedTitle: "Tersimpan!", savedMsg: "Surah {s}, Ayat {a} tersimpan.", continueBtn: "Lanjutkan Membaca"
            }
        };

        window.addEventListener('load', () => { 
            initLocationAndPrayer();
            updateLangUI();
            fetchSurahList();
            checkLastRead();
        });

        function switchLang(lang) {
            if(currentLang === lang) return;
            currentLang = lang;
            localStorage.setItem('quran_lang', lang);
            updateLangUI();
            renderSurahList(allSurahs); 
            if(currentSurahMeta) loadSurah(currentSurahMeta.number);
            checkLastRead();
            updatePrayerTable();
        }

        function updateLangUI() {
            document.getElementById('btn-id').className = `lang-btn ${currentLang === 'id' ? 'active' : ''}`;
            document.getElementById('btn-en').className = `lang-btn ${currentLang === 'en' ? 'active' : ''}`;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[currentLang][key]) el.innerHTML = i18n[currentLang][key];
            });
            document.getElementById('search').placeholder = i18n[currentLang].searchPlaceholder;
        }

        async function initLocationAndPrayer() {
            startClock(); 
            try {
                const locRes = await fetch('https://ipinfo.io/json?token=648603417769e5');
                const locData = await locRes.json();
                const [lat, lng] = locData.loc.split(',');
                userCoords = { lat: parseFloat(lat), lng: parseFloat(lng) };
                
                document.getElementById('user-location').innerText = `${locData.city}, ${locData.country}`;
                document.getElementById('prayer-loc-display').innerText = `${locData.city}, ${locData.country}`;

                const date = Math.floor(Date.now() / 1000);
                const prayerUrl = `${PRAYER_API}/${date}?latitude=${lat}&longitude=${lng}&method=2`;
                
                const pRes = await fetch(prayerUrl);
                const pData = await pRes.json();
                
                prayerTimings = pData.data.timings;
                updatePrayerDisplay();
                updatePrayerTable();

            } catch (e) {
                console.log("Loc Failed");
                document.getElementById('user-location').innerText = "Jakarta (Fallback)";
                document.getElementById('prayer-loc-display').innerText = "Jakarta (Fallback)";
                prayerTimings = { Fajr: "04:40", Dhuhr: "12:00", Asr: "15:15", Maghrib: "18:05", Isha: "19:15" };
                updatePrayerDisplay();
                updatePrayerTable();
            }
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                const timeString = now.toLocaleTimeString(currentLang === 'id' ? 'id-ID' : 'en-US', { hour: '2-digit', minute: '2-digit' });
                document.querySelectorAll('.clock-display').forEach(el => el.innerText = timeString);
                if(prayerTimings) updatePrayerDisplay(); 
            }, 1000);
        }

        function updatePrayerDisplay() {
            if(!prayerTimings) return;
            const now = new Date();
            const curTime = now.getHours() * 60 + now.getMinutes();
            const toMins = (t) => parseInt(t.split(':')[0])*60 + parseInt(t.split(':')[1]);

            const prayers = [
                { name: "Subuh", time: toMins(prayerTimings.Fajr) },
                { name: "Dzuhur", time: toMins(prayerTimings.Dhuhr) },
                { name: "Ashar", time: toMins(prayerTimings.Asr) },
                { name: "Maghrib", time: toMins(prayerTimings.Maghrib) },
                { name: "Isya", time: toMins(prayerTimings.Isha) }
            ];

            let current = "Isya (Late)";
            for(let i = 0; i < prayers.length; i++) {
                if(curTime >= prayers[i].time) current = prayers[i].name;
            }
            document.getElementById('prayer-desktop').innerText = current;
            document.getElementById('prayer-mobile').innerText = current;
        }

        function updatePrayerTable() {
            if(!prayerTimings) return;
            const list = [
                { id: "Subuh", en: "Fajr", t: prayerTimings.Fajr },
                { id: "Dzuhur", en: "Dhuhr", t: prayerTimings.Dhuhr },
                { id: "Ashar", en: "Asr", t: prayerTimings.Asr },
                { id: "Maghrib", en: "Maghrib", t: prayerTimings.Maghrib },
                { id: "Isya", en: "Isha", t: prayerTimings.Isha },
            ];
            
            const now = new Date();
            const curTime = now.getHours() * 60 + now.getMinutes();
            const toMins = (t) => parseInt(t.split(':')[0])*60 + parseInt(t.split(':')[1]);

            let html = "";
            let activeIdx = -1;
            for(let i=0; i<list.length; i++) { if(curTime >= toMins(list[i].t)) activeIdx = i; }

            list.forEach((p, idx) => {
                const name = currentLang === 'id' ? p.id : p.en;
                const activeClass = (idx === activeIdx) ? 'highlight' : '';
                html += `<div class="prayer-row ${activeClass}"><span>${name}</span><span>${p.t}</span></div>`;
            });
            document.getElementById('prayer-table-body').innerHTML = html;
        }

        function openQibla() { document.getElementById('qibla-modal').classList.add('active'); }
        
        function initCompass() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            document.getElementById('start-compass-btn').style.display = 'none';
                            document.getElementById('compass-status').innerText = "Compass Active";
                        } else { alert('Permission denied'); }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                document.getElementById('start-compass-btn').style.display = 'none';
                document.getElementById('compass-status').innerText = "Compass Active";
            }
        }

        function handleOrientation(e) {
            const qibla = calculateQibla(userCoords.lat, userCoords.lng);
            let heading = e.webkitCompassHeading || Math.abs(e.alpha - 360);
            document.getElementById('compass-disc').style.transform = `rotate(${-heading}deg)`;
            document.getElementById('kaaba-pointer').style.transform = `translate(-50%, -100%) rotate(${qibla}deg)`;
        }

        function calculateQibla(lat, lng) {
            const PI = Math.PI;
            const latk = 21.4225 * PI / 180.0;
            const longk = 39.8262 * PI / 180.0;
            const phi = lat * PI / 180.0;
            const lambda = lng * PI / 180.0;
            const q = Math.atan2(Math.sin(longk - lambda), Math.cos(phi) * Math.tan(latk) - Math.sin(phi) * Math.cos(longk - lambda));
            return q * 180.0 / PI; 
        }

        async function fetchSurahList() {
            try {
                const res = await fetch(`${API_BASE}/surah`);
                const data = await res.json();
                allSurahs = data.data;
                renderSurahList(allSurahs);
            } catch (err) {
                document.getElementById('surah-list-container').innerHTML = `<div style="text-align:center; padding:20px; color:red;">Connection Error</div>`;
            }
        }

        function renderSurahList(list) {
            const container = document.getElementById('surah-list-container');
            container.innerHTML = list.map(surah => {
                let displayName = surah.englishName;
                let displayMean = surah.englishNameTranslation;
                if (currentLang === 'id') displayMean = surahID[surah.number - 1] || surah.englishNameTranslation;
                return `
                <div class="surah-item" id="surah-item-${surah.number}" onclick="loadSurah(${surah.number})">
                    <div style="display:flex; align-items:center;">
                        <div class="s-num">${surah.number}</div>
                        <div class="s-info"><h4>${displayName}</h4><span>${displayMean}</span></div>
                    </div>
                    <div class="s-arabic">${surah.name.replace('سُورَةُ ', '')}</div>
                </div>
            `}).join('');
        }

        async function loadSurah(number) {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('ayah-container').innerHTML = '';
            document.getElementById('bismillah').style.display = 'none';
            document.getElementById('app-footer').style.display = 'none';
            if(window.innerWidth <= 900) document.getElementById('sidebar').classList.remove('open');

            document.querySelectorAll('.surah-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`surah-item-${number}`);
            if(activeItem) activeItem.classList.add('active');

            try {
                const editionLang = currentLang === 'id' ? 'id.indonesian' : 'en.sahih';
                // Using Alquran.cloud API
                const url = `${API_BASE}/surah/${number}/editions/quran-uthmani,en.transliteration,${editionLang}`;
                const res = await fetch(url);
                const data = await res.json();

                const arabicData = data.data[0];
                const latinData = data.data[1];
                const transData = data.data[2];

                currentSurahMeta = arabicData;
                document.getElementById('header-title').innerText = `${arabicData.number}. ${arabicData.englishName}`;

                if (number !== 9 && number !== 1) document.getElementById('bismillah').style.display = 'block';

                renderAyahs(arabicData.ayahs, latinData.ayahs, transData.ayahs);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('app-footer').style.display = 'block';
            } catch (err) {
                document.getElementById('loader').innerHTML = `<div style="text-align:center"><button onclick="loadSurah(${number})">Retry</button></div>`;
            }
        }

        function renderAyahs(arabic, latin, trans) {
            const container = document.getElementById('ayah-container');
            let html = '';
            arabic.forEach((ayah, index) => {
                html += `
                    <div class="ayah-card" id="ayah-${ayah.numberInSurah}">
                        <div class="ayah-header">
                            <span class="ayah-num">${currentSurahMeta.number}:${ayah.numberInSurah}</span>
                            <div class="ayah-actions">
                                <button onclick="bookmark(${currentSurahMeta.number}, ${ayah.numberInSurah}, '${currentSurahMeta.englishName}')"><i class="far fa-bookmark"></i></button>
                                <button onclick="playAudio(${ayah.number}, this)"><i class="fas fa-play"></i></button>
                            </div>
                        </div>
                        <div class="ayah-arabic">${ayah.text}</div>
                        <div class="ayah-latin">${latin[index].text}</div>
                        <div class="ayah-trans">${trans[index].text}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        const audioPlayer = document.getElementById('quran-audio');
        let currentBtn = null;
        function playAudio(globalAyahId, btn) {
            const url = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${globalAyahId}.mp3`;
            if(currentBtn === btn && !audioPlayer.paused) { audioPlayer.pause(); resetBtn(btn); return; }
            if(currentBtn) resetBtn(currentBtn);
            currentBtn = btn;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            audioPlayer.src = url; audioPlayer.play();
            document.getElementById('audio-status').style.display = 'block';
            audioPlayer.onplaying = () => { btn.innerHTML = '<i class="fas fa-pause"></i>'; btn.closest('.ayah-card').classList.add('playing'); };
            audioPlayer.onended = () => { resetBtn(btn); document.getElementById('audio-status').style.display = 'none'; };
            audioPlayer.onerror = () => { resetBtn(btn); };
        }
        function resetBtn(btn) { btn.innerHTML = '<i class="fas fa-play"></i>'; btn.closest('.ayah-card').classList.remove('playing'); }

        function bookmark(surah, ayah, name) {
            const data = { surah, ayah, name, timestamp: new Date().getTime() };
            localStorage.setItem('quran_last_read', JSON.stringify(data));
            checkLastRead();
            let msg = i18n[currentLang].savedMsg.replace('{s}', name).replace('{a}', ayah);
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('save-modal').classList.add('active');
        }

        function checkLastRead() {
            const raw = localStorage.getItem('quran_last_read');
            if(raw) {
                const data = JSON.parse(raw);
                const card = document.getElementById('last-read-card');
                const ayahLabel = currentLang === 'id' ? 'Ayat' : 'Ayah';
                document.getElementById('lr-text').innerText = `${data.name} : ${ayahLabel} ${data.ayah}`;
                card.style.display = 'block';
            }
        }

        function loadLastRead() {
            const raw = localStorage.getItem('quran_last_read');
            if(raw) {
                const data = JSON.parse(raw);
                loadSurah(data.surah).then(() => {
                    setTimeout(() => {
                        const el = document.getElementById(`ayah-${data.ayah}`);
                        if(el) { el.scrollIntoView({behavior: 'smooth', block: 'center'}); el.style.background = 'var(--primary-soft)'; setTimeout(() => el.style.background = 'var(--bg-surface)', 2000); }
                    }, 1200);
                });
            }
        }

        function closeModal(e) { if(e.target.id === 'save-modal' || e.target.id === 'qibla-modal') e.target.classList.remove('active'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function filterSurahs() {
            const query = document.getElementById('search').value.toLowerCase();
            const filtered = allSurahs.filter(s => 
                s.englishName.toLowerCase().includes(query) || 
                (currentLang === 'id' && surahID[s.number-1].toLowerCase().includes(query)) ||
                String(s.number).includes(query)
            );
            renderSurahList(filtered);
        }
    </script>
</body>
</html>
